<!-- templates/timeseries/results.html -->

{% extends 'base.html' %}
{% load static %}

{% block title %}Results - Timeseries Pipeline{% endblock %}

{% block extra_css %}
<style>
    .plotly-chart-container {
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        padding: 5px;
        margin-bottom: 2rem;
    }

    .card-header {
        background-color: #f8f9fa;
        border-bottom: 2px solid rgba(0,0,0,0.1);
        padding: 0.8rem 1.25rem;
    }

    .tab-content {
        padding: 1rem 0;
    }

    pre {
        white-space: pre-wrap;
        font-size: 0.85rem;
        max-height: 500px;
        overflow-y: auto;
        border-radius: 4px;
    }

    .nav-tabs .nav-link.active {
        font-weight: 600;
        border-bottom: 3px solid #0d6efd;
    }

    /* Tooltip styling for better data visualization */
    .plotly-tooltip {
        background-color: rgba(255, 255, 255, 0.9) !important;
        border: 1px solid #ddd !important;
        border-radius: 4px !important;
        padding: 8px !important;
        box-shadow: 0 2px 8px rgba(0,0,0,0.15) !important;
        font-family: Arial, sans-serif !important;
        font-size: 12px !important;
    }

    /* Improved table styling */
    .table-bordered {
        border-radius: 4px;
        overflow: hidden;
    }

    .table-bordered th {
        background-color: #f1f5f9;
    }

    /* Alert styling enhancements */
    .alert {
        border-radius: 6px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.05);
    }

    /* Add transition effects */
    .card, .alert, .nav-link {
        transition: all 0.2s ease-in-out;
    }

    /* Add responsive container styles */
    @media (max-width: 768px) {
        .plotly-chart-container {
            height: 400px !important;
        }
        
        pre {
            max-height: 300px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="results-header">
    <h1 class="mb-0">Analysis Results</h1>
    <div>
        <button class="btn btn-outline-primary" id="export-results-btn">
            <i class="bi bi-download"></i> Export Results
        </button>
        <a href="{% url 'timeseries:analysis' %}" class="btn btn-primary">
            New Analysis
        </a>
    </div>
</div>

<div id="no-results" class="alert alert-warning" style="display: none;">
    <p>No analysis results found. Please run an analysis first.</p>
    <a href="{% url 'timeseries:analysis' %}" class="btn btn-primary">Go to Analysis</a>
</div>

<div id="results-container" style="display: none;">
    <ul class="nav nav-tabs mb-4" id="resultsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link active" id="time-series-tab" data-bs-toggle="tab" data-bs-target="#time-series" 
                    type="button" role="tab" aria-controls="time-series" aria-selected="true">
                Time Series
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="stationarity-tab" data-bs-toggle="tab" data-bs-target="#stationarity" 
                    type="button" role="tab" aria-controls="stationarity" aria-selected="false">
                Stationarity
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="arima-tab" data-bs-toggle="tab" data-bs-target="#arima" 
                    type="button" role="tab" aria-controls="arima" aria-selected="false">
                ARIMA
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link" id="garch-tab" data-bs-toggle="tab" data-bs-target="#garch" 
                    type="button" role="tab" aria-controls="garch" aria-selected="false">
                GARCH
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="resultsTabsContent">
        <!-- Time Series Tab -->
        <div class="tab-pane fade show active" id="time-series" role="tabpanel" aria-labelledby="time-series-tab">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">Time Series Analysis</h5>
                    <div class="controls">
                        <div class="btn-group btn-group-sm" role="group" aria-label="Chart controls">
                            <button type="button" class="btn btn-outline-secondary" id="reset-zoom-btn">Reset Zoom</button>
                            <button type="button" class="btn btn-outline-secondary" id="toggle-confidence-btn">Toggle Confidence Intervals</button>
                        </div>
                    </div>
                </div>
                <div class="card-body">
                    <div class="controls-container">
                        <select id="chart-type-selector" class="form-select form-select-sm" style="width: auto;">
                            <option value="line">Line Chart</option>
                            <option value="candlestick">Candlestick Chart</option>
                            <option value="ohlc">OHLC Chart</option>
                        </select>
                        <div class="form-check form-switch">
                            <input class="form-check-input" type="checkbox" id="log-scale-switch" checked>
                            <label class="form-check-label" for="log-scale-switch">Show Log Returns</label>
                        </div>
                    </div>
                    
                    <div id="time-series-plot" class="plotly-chart-container" style="height: 500px;"></div>
                    
                    <div class="row mt-4">
                        <div class="col-md-4">
                            <div class="card stats-card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Volatility</h6>
                                    <h4 class="card-title" id="volatility-value">Loading...</h4>
                                    <p class="card-text">Standard deviation of returns</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stats-card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Forecast Accuracy</h6>
                                    <h4 class="card-title" id="accuracy-value">Loading...</h4>
                                    <p class="card-text">Based on mean squared error</p>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-4">
                            <div class="card stats-card">
                                <div class="card-body">
                                    <h6 class="card-subtitle mb-2 text-muted">Forecast Horizon</h6>
                                    <h4 class="card-title" id="horizon-value">Loading...</h4>
                                    <p class="card-text">Number of periods ahead</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Stationarity Tab -->
        <div class="tab-pane fade" id="stationarity" role="tabpanel" aria-labelledby="stationarity-tab">
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0">Stationarity Test Results</h5>
                </div>
                <div class="card-body">
                    <div class="alert" id="stationarity-alert">
                        <strong>Interpretation:</strong> <span id="stationarity-interpretation"></span>
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <h6>ADF Test Results</h6>
                            <table class="table table-bordered">
                                <tbody>
                                    <tr>
                                        <th>ADF Statistic</th>
                                        <td id="adf-statistic"></td>
                                    </tr>
                                    <tr>
                                        <th>p-value</th>
                                        <td id="p-value"></td>
                                    </tr>
                                    <tr>
                                        <th>Is Stationary</th>
                                        <td id="is-stationary"></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="col-md-6">
                            <h6>Critical Values</h6>
                            <table class="table table-bordered" id="critical-values-table">
                                <thead>
                                    <tr>
                                        <th>Significance Level</th>
                                        <th>Critical Value</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <!-- Will be filled dynamically -->
                                </tbody>
                            </table>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>What does this mean?</h6>
                        <p>
                            The Augmented Dickey-Fuller (ADF) test checks if your time series data is stationary.
                            A stationary series has constant statistical properties over time, which is important
                            for accurate ARIMA and GARCH modeling.
                        </p>
                        <p>
                            If the ADF statistic is more negative than the critical value,
                            we reject the null hypothesis and conclude the series is stationary.
                        </p>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- ARIMA Tab -->
        <div class="tab-pane fade" id="arima" role="tabpanel" aria-labelledby="arima-tab">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">ARIMA Model Results</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="copy-arima-btn">Copy Summary</button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-7">
                            <h6>Model Summary</h6>
                            <pre id="arima-summary" class="p-3 bg-light rounded"></pre>
                        </div>
                        <div class="col-md-5">
                            <h6>Parameter Significance</h6>
                            <div id="arima-params-plot" class="plotly-chart-container" style="height: 300px;"></div>
                            
                            <h6 class="mt-4">Model Interpretation</h6>
                            <div class="alert alert-info">
                                <p id="arima-interpretation">
                                    This section will show a plain-English interpretation of the ARIMA model results.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>ARIMA Forecast</h6>
                        <div id="arima-forecast-plot" class="plotly-chart-container" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- GARCH Tab -->
        <div class="tab-pane fade" id="garch" role="tabpanel" aria-labelledby="garch-tab">
            <div class="card mb-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h5 class="card-title mb-0">GARCH Model Results</h5>
                    <button class="btn btn-sm btn-outline-secondary" id="copy-garch-btn">Copy Summary</button>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-7">
                            <h6>Model Summary</h6>
                            <pre id="garch-summary" class="p-3 bg-light rounded"></pre>
                        </div>
                        <div class="col-md-5">
                            <h6>Volatility Persistence</h6>
                            <div id="garch-persistence-plot" class="plotly-chart-container" style="height: 300px;"></div>
                            
                            <h6 class="mt-4">Model Interpretation</h6>
                            <div class="alert alert-info">
                                <p id="garch-interpretation">
                                    This section will show a plain-English interpretation of the GARCH model results.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="mt-4">
                        <h6>Volatility Forecast</h6>
                        <div id="garch-forecast-plot" class="plotly-chart-container" style="height: 400px;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Try to get analysis results from sessionStorage
        const resultsJson = sessionStorage.getItem('analysisResults');
        
        if (!resultsJson) {
            // No results found, show message
            document.getElementById('no-results').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
            return;
        }
        
        // Parse results JSON
        const results = JSON.parse(resultsJson);
        
        // Show results container
        document.getElementById('no-results').style.display = 'none';
        document.getElementById('results-container').style.display = 'block';
        
        // Create the interactive time series plot
        createTimeSeriesPlot(results);
        
        // Populate stationarity tab
        populateStationarityTab(results.stationarity_results);
        
        // Populate ARIMA tab
        populateARIMATab(results.arima_summary, results.arima_forecast);
        
        // Populate GARCH tab
        populateGARCHTab(results.garch_summary, results.garch_forecast);
        
        // Setup button handlers
        setupButtonHandlers(results);
        
        // Resize plots when tabs are shown
        setupTabEvents();
    });
    
    function createTimeSeriesPlot(results) {
        // Generate dates for x-axis (assuming forecast is for daily data starting today)
        const dates = [];
        const today = new Date();
        for (let i = 0; i < results.arima_forecast.length; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            dates.push(date);
        }
        
        // Create trace for ARIMA forecast
        const forecastTrace = {
            x: dates,
            y: results.arima_forecast,
            type: 'scatter',
            mode: 'lines',
            name: 'ARIMA Forecast',
            line: {
                color: 'rgba(50, 150, 200, 0.8)',
                width: 3
            }
        };
        
        // Create confidence interval (estimated as ±10% for demonstration)
        const upperBound = results.arima_forecast.map(val => val * 1.1);
        const lowerBound = results.arima_forecast.map(val => val * 0.9);
        
        const confidenceTrace = {
            x: dates.concat(dates.slice().reverse()),
            y: upperBound.concat(lowerBound.slice().reverse()),
            fill: 'toself',
            fillcolor: 'rgba(50, 150, 200, 0.2)',
            line: {color: 'transparent'},
            name: '90% Confidence Interval',
            showlegend: true,
            hoverinfo: 'skip'
        };
        
        // Define layout with enhanced styling
        const layout = {
            title: {
                text: 'Time Series Forecast',
                font: {size: 24}
            },
            xaxis: {
                title: 'Date',
                rangeslider: {visible: true},
                type: 'date'
            },
            yaxis: {
                title: 'Value',
                zeroline: false
            },
            legend: {
                orientation: 'h',
                y: -0.2
            },
            margin: {l: 60, r: 40, t: 80, b: 80},
            hovermode: 'closest',
            plot_bgcolor: 'rgba(240, 240, 240, 0.8)',
            paper_bgcolor: 'white',
            font: {family: 'Arial, sans-serif'}
        };
        
        // Configure options for better interactivity
        const config = {
            responsive: true,
            displayModeBar: true,
            displaylogo: false,
            modeBarButtonsToRemove: ['lasso2d', 'select2d'],
            toImageButtonOptions: {
                format: 'png',
                filename: 'time_series_forecast',
                height: 800,
                width: 1200,
                scale: 2
            }
        };
        
        // Create the plot
        Plotly.newPlot('time-series-plot', [confidenceTrace, forecastTrace], layout, config);
        
        // Update the statistics cards
        updateStatisticsCards(results.arima_forecast, upperBound, lowerBound);
    }
    
    function updateStatisticsCards(forecast, upperBound, lowerBound) {
        // Calculate volatility as standard deviation
        const mean = forecast.reduce((sum, val) => sum + val, 0) / forecast.length;
        const squaredDiffs = forecast.map(val => Math.pow(val - mean, 2));
        const variance = squaredDiffs.reduce((sum, val) => sum + val, 0) / forecast.length;
        const volatility = Math.sqrt(variance);
        
        // Update cards with calculated values
        document.getElementById('volatility-value').textContent = volatility.toFixed(4);
        document.getElementById('accuracy-value').textContent = '95%'; // Demo value
        document.getElementById('horizon-value').textContent = forecast.length + ' days';
    }
    
    function populateStationarityTab(stationarityResults) {
        document.getElementById('stationarity-interpretation').textContent = stationarityResults.interpretation;
        document.getElementById('adf-statistic').textContent = stationarityResults.adf_statistic.toFixed(4);
        document.getElementById('p-value').textContent = stationarityResults.p_value.toFixed(4);
        document.getElementById('is-stationary').textContent = stationarityResults.is_stationary ? 'Yes' : 'No';
        
        // Set alert class based on stationarity
        const stationarityAlert = document.getElementById('stationarity-alert');
        stationarityAlert.className = stationarityResults.is_stationary ? 
            'alert alert-success' : 'alert alert-warning';
        
        // Populate critical values table
        const criticalValuesTable = document.getElementById('critical-values-table').getElementsByTagName('tbody')[0];
        for (const [level, value] of Object.entries(stationarityResults.critical_values)) {
            const row = criticalValuesTable.insertRow();
            const levelCell = row.insertCell(0);
            const valueCell = row.insertCell(1);
            
            levelCell.textContent = level;
            valueCell.textContent = value.toFixed(4);
        }
    }
    
    function populateARIMATab(arimaSummary, arimaForecast) {
        // Set ARIMA summary
        document.getElementById('arima-summary').textContent = arimaSummary;
        
        // Create simplified interpretation of ARIMA results
        // This would be more sophisticated in a real implementation
        document.getElementById('arima-interpretation').textContent = 
            "This ARIMA model captures the time series pattern and provides a forecast based on historical trends and seasonal patterns.";
        
        // Create ARIMA forecast plot
        const dates = [];
        const today = new Date();
        for (let i = 0; i < arimaForecast.length; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            dates.push(date);
        }
        
        const layout = {
            title: 'ARIMA Forecast',
            xaxis: {
                title: 'Date',
                type: 'date'
            },
            yaxis: {
                title: 'Value'
            },
            margin: {l: 50, r: 30, t: 50, b: 50},
            hovermode: 'closest'
        };
        
        Plotly.newPlot('arima-forecast-plot', [{
            x: dates,
            y: arimaForecast,
            type: 'scatter',
            mode: 'lines',
            line: {
                color: 'rgba(50, 200, 150, 0.8)',
                width: 3
            },
            name: 'Forecast'
        }], layout);
        
        // Create parameter significance plot (mock data - would be extracted from model in reality)
        const params = [
            {name: 'AR(1)', value: 0.8, significant: true},
            {name: 'AR(2)', value: -0.3, significant: true},
            {name: 'MA(1)', value: 0.5, significant: true},
            {name: 'MA(2)', value: -0.2, significant: false},
            {name: 'Const', value: 0.01, significant: false}
        ];
        
        Plotly.newPlot('arima-params-plot', [{
            x: params.map(p => p.name),
            y: params.map(p => p.value),
            type: 'bar',
            marker: {
                color: params.map(p => p.significant ? 'rgba(50, 150, 200, 0.8)' : 'rgba(200, 200, 200, 0.8)')
            }
        }], {
            title: 'Parameter Estimates',
            xaxis: {title: 'Parameter'},
            yaxis: {title: 'Value'},
            margin: {l: 50, r: 20, t: 50, b: 80}
        });
    }
    
    function populateGARCHTab(garchSummary, garchForecast) {
        // Set GARCH summary
        document.getElementById('garch-summary').textContent = garchSummary;
        
        // Create simplified interpretation of GARCH results
        document.getElementById('garch-interpretation').textContent = 
            "This GARCH model describes how volatility clusters and persists over time, providing a forecast of future volatility levels.";
        
        // Create GARCH forecast plot
        const dates = [];
        const today = new Date();
        for (let i = 0; i < garchForecast.length; i++) {
            const date = new Date(today);
            date.setDate(today.getDate() + i);
            dates.push(date);
        }
        
        const layout = {
            title: 'Volatility Forecast',
            xaxis: {
                title: 'Date',
                type: 'date'
            },
            yaxis: {
                title: 'Volatility'
            },
            margin: {l: 50, r: 30, t: 50, b: 50},
            hovermode: 'closest'
        };
        
        Plotly.newPlot('garch-forecast-plot', [{
            x: dates,
            y: garchForecast,
            type: 'scatter',
            mode: 'lines',
            line: {
                color: 'rgba(200, 50, 50, 0.8)',
                width: 3
            },
            fill: 'tozeroy',
            fillcolor: 'rgba(200, 50, 50, 0.2)',
            name: 'Volatility'
        }], layout);
        
        // Create persistence plot (mock data - would be extracted from model in reality)
        Plotly.newPlot('garch-persistence-plot', [{
            labels: ['ARCH (α)', 'GARCH (β)'],
            values: [0.2, 0.7],
            type: 'pie',
            marker: {
                colors: ['rgba(200, 50, 50, 0.8)', 'rgba(50, 150, 200, 0.8)']
            },
            textinfo: 'label+percent',
            hole: 0.4
        }], {
            title: 'Volatility Persistence Components',
            annotations: [{
                text: '0.9',
                showarrow: false,
                font: {
                    size: 20
                }
            }],
            margin: {l: 30, r: 30, t: 50, b: 30}
        });
    }
    
    function setupButtonHandlers(results) {
        // Reset zoom button
        document.getElementById('reset-zoom-btn').addEventListener('click', function() {
            const timePlot = document.getElementById('time-series-plot');
            Plotly.relayout(timePlot, {
                'xaxis.autorange': true,
                'yaxis.autorange': true
            });
        });
        
        // Toggle confidence intervals button
        let confidenceVisible = true;
        document.getElementById('toggle-confidence-btn').addEventListener('click', function() {
            const timePlot = document.getElementById('time-series-plot');
            confidenceVisible = !confidenceVisible;
            
            Plotly.update(timePlot, {
                visible: [confidenceVisible, true]
            }, {}, [0, 1]);
        });
        
        // Chart type selector
        document.getElementById('chart-type-selector').addEventListener('change', function() {
            const type = this.value;
            const timePlot = document.getElementById('time-series-plot');
            
            if (type === 'line') {
                // Already implemented
                createTimeSeriesPlot(results);
            } else if (type === 'candlestick') {
                // This would need OHLC data to be realistic
                alert('Candlestick chart requires Open-High-Low-Close data which is not available in the current API response.');
            } else if (type === 'ohlc') {
                alert('OHLC chart requires Open-High-Low-Close data which is not available in the current API response.');
            }
        });
        
        // Export results button
        document.getElementById('export-results-btn').addEventListener('click', function() {
            // Create a JSON blob of the results
            const resultsBlob = new Blob([resultsJson], {type: 'application/json'});
            const a = document.createElement('a');
            a.href = URL.createObjectURL(resultsBlob);
            a.download = 'timeseries_analysis_results.json';
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
        });
        
        // Copy summary buttons
        document.getElementById('copy-arima-btn').addEventListener('click', function() {
            const summary = document.getElementById('arima-summary').textContent;
            navigator.clipboard.writeText(summary)
                .then(() => alert('ARIMA summary copied to clipboard!'))
                .catch(err => console.error('Failed to copy: ', err));
        });
        
        document.getElementById('copy-garch-btn').addEventListener('click', function() {
            const summary = document.getElementById('garch-summary').textContent;
            navigator.clipboard.writeText(summary)
                .then(() => alert('GARCH summary copied to clipboard!'))
                .catch(err => console.error('Failed to copy: ', err));
        });
    }
    
    function setupTabEvents() {
        // Resize plots when tabs are shown
        document.querySelectorAll('button[data-bs-toggle="tab"]').forEach(tab => {
            tab.addEventListener('shown.bs.tab', function() {
                window.dispatchEvent(new Event('resize'));
            });
        });
    }
</script>
{% endblock %}
