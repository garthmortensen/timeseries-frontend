<!--
# === FILE META OPENING ===
# file: ./timeseries-frontend/templates/timeseries/results.html
# role: frontend
# desc: main results page template that displays interactive charts and analysis results with tabbed navigation
# === FILE META CLOSING ===
-->

{% extends 'base.html' %}
{% load static %}

{% block title %}Lab:Results{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Analysis Results</h1>
    <div class="btn-group" role="group">
        <button id="download-api-response-btn" class="btn btn-outline-primary">
            <i class="bi bi-download"></i> Download Full API Response
        </button>
        <button id="view-api-response-btn" class="btn btn-outline-secondary">
            <i class="bi bi-eye"></i> View Raw JSON
        </button>
    </div>
</div>

<!-- view JSON payload -->
<div class="modal fade" id="jsonModal" tabindex="-1" aria-labelledby="jsonModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="jsonModalLabel">Raw API Response</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="mb-3">
                    <small class="text-muted">
                        This is the complete JSON response from the API.
                    </small>
                </div>
                <pre id="json-content" style="max-height: 60vh; overflow: auto; background-color: #e6e9ed; padding: 1rem; border-radius: 0.375rem; font-size: 0.875rem;"></pre>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="copy-json-btn">Copy to Clipboard</button>
            </div>
        </div>
    </div>
</div>

<div id="no-results" class="alert alert-warning" style="display: none;">
    <p>No analysis results found. Please run an analysis first.</p>
    <a href="{% url 'timeseries:analysis' %}" class="btn btn-primary">Go to Analysis</a>
</div>

<div id="loading-indicator" class="text-center" style="display: none;">
    <p id="loading-text">Running analysis, please wait...</p>
    <div class="spinner-border" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
</div>

<div id="results-container" style="display: none;">
    <!-- Main Navigation Tabs -->
    <ul class="nav nav-tabs mb-4" id="resultsTabs" role="tablist">
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'overview' %}active{% endif %}" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" 
                    type="button" role="tab" aria-controls="overview" aria-selected="{% if active_tab == 'overview' %}true{% else %}false{% endif %}">
                <i class="bi bi-speedometer2"></i> Overview
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'execution-config' %}active{% endif %}" id="execution-config-tab" data-bs-toggle="tab" data-bs-target="#execution-config" 
                    type="button" role="tab" aria-controls="execution-config" aria-selected="{% if active_tab == 'execution-config' %}true{% else %}false{% endif %}">
                <i class="bi bi-gear"></i> Execution Configuration
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'plots' %}active{% endif %}" id="plots-tab" data-bs-toggle="tab" data-bs-target="#plots" 
                    type="button" role="tab" aria-controls="plots" aria-selected="{% if active_tab == 'plots' %}true{% else %}false{% endif %}">
                <i class="bi bi-diagram-3"></i> Plots
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'statistical-tests' %}active{% endif %}" id="statistical-tests-tab" data-bs-toggle="tab" data-bs-target="#statistical-tests" 
                    type="button" role="tab" aria-controls="statistical-tests" aria-selected="{% if active_tab == 'statistical-tests' %}true{% else %}false{% endif %}">
                <i class="bi bi-graph-up"></i> Statistical Tests
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'models' %}active{% endif %}" id="models-tab" data-bs-toggle="tab" data-bs-target="#models" 
                    type="button" role="tab" aria-controls="models" aria-selected="{% if active_tab == 'models' %}true{% else %}false{% endif %}">
                <i class="bi bi-cpu"></i> Models & Forecasts
            </button>
        </li>
        {% if spillover_results %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'spillover' %}active{% endif %}" id="spillover-tab" data-bs-toggle="tab" data-bs-target="#spillover" 
                    type="button" role="tab" aria-controls="spillover" aria-selected="{% if active_tab == 'spillover' %}true{% else %}false{% endif %}">
                <i class="bi bi-arrows-angle-expand"></i> Spillover Analysis
            </button>
        </li>
        {% endif %}
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'granger-causality' %}active{% endif %}" id="granger-causality-tab" data-bs-toggle="tab" data-bs-target="#granger-causality"
                    type="button" role="tab" aria-controls="granger-causality" aria-selected="{% if active_tab == 'granger-causality' %}true{% else %}false{% endif %}">
                <i class="bi bi-arrow-through-heart"></i> Granger Causality
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'raw-data' %}active{% endif %}" id="raw-data-tab" data-bs-toggle="tab" data-bs-target="#raw-data-pane" 
                    type="button" role="tab" aria-controls="raw-data-pane" aria-selected="{% if active_tab == 'raw-data' %}true{% else %}false{% endif %}">
                <i class="bi bi-table"></i> Raw Data
            </button>
        </li>
        <li class="nav-item" role="presentation">
            <button class="nav-link {% if active_tab == 'next-step' %}active{% endif %}" id="next-step-tab" data-bs-toggle="tab" data-bs-target="#next-step-pane" 
                    type="button" role="tab" aria-controls="next-step-pane" aria-selected="{% if active_tab == 'next-step' %}true{% else %}false{% endif %}">
                <i class="bi bi-arrow-right-circle"></i> Next Step
            </button>
        </li>
    </ul>
    
    <div class="tab-content" id="resultsTabsContent">
        
        <!-- Overview Tab -->
        <div class="tab-pane fade {% if active_tab == 'overview' %}show active{% endif %}" id="overview" role="tabpanel" aria-labelledby="overview-tab">
            <div class="row">
                <div class="col-md-8">
                    <!-- Executive Summary Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="bi bi-briefcase"></i> Executive Summary</h5>
                        </div>
                        <div class="card-body" id="executive-summary-content">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                    
                    <!-- Key Insights Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="bi bi-lightbulb"></i> Key Insights</h5>
                        </div>
                        <div class="card-body" id="key-insights-content">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
                
                <div class="col-md-4">
                    <!-- Analysis Summary Card -->
                    <div class="card mb-4">
                        <div class="card-header">
                            <h5 class="card-title mb-0"><i class="bi bi-info-circle"></i> Analysis Summary</h5>
                        </div>
                        <div class="card-body" id="analysis-summary-content">
                            <!-- Populated by JavaScript -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Execution Configuration Tab -->
        <div class="tab-pane fade {% if active_tab == 'execution-config' %}show active{% endif %}" id="execution-config" role="tabpanel" aria-labelledby="execution-config-tab">
            <div class="alert alert-info mb-4">
                <i class="bi bi-info-circle"></i>
                <strong>Analysis Configuration:</strong> This section shows all the parameters and settings that were used to execute this analysis.
            </div>
            
            <!-- Data Source Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-database"></i> Data Source Configuration</h5>
                </div>
                <div class="card-body">
                    <div id="data-source-config-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Data Processing Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-gear"></i> Data Processing Configuration</h5>
                </div>
                <div class="card-body">
                    <div id="data-processing-config-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Model Configurations -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-cpu"></i> Model Configurations</h5>
                </div>
                <div class="card-body">
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-graph-up-arrow"></i> ARIMA Parameters</h6>
                            <div id="arima-config-content">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-lightning"></i> GARCH Parameters</h6>
                            <div id="garch-config-content">
                                <!-- Populated by JavaScript -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Spillover Configuration -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-shuffle"></i> Spillover Analysis Configuration</h5>
                </div>
                <div class="card-body">
                    <div id="spillover-config-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
            
            <!-- Execution Metadata -->
            <div class="card mb-4">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-clock"></i> Execution Metadata</h5>
                </div>
                <div class="card-body">
                    <div id="execution-metadata-content">
                        <!-- Populated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Plotted Transformations Tab -->
        <div class="tab-pane fade {% if active_tab == 'plots' %}show active{% endif %}" id="plots" role="tabpanel" aria-labelledby="plots-tab">
            {% if plots %}
            <div class="row mb-4">
                <div class="col-12">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Interactive Charts:</strong> All plots are generated server-side using Plotly and are fully interactive. 
                        You can zoom, pan, hover for details, and toggle series on/off by clicking the legend.
                    </div>
                </div>
            </div>
            
            <!-- Collapsible Data Sections -->
            <div class="accordion" id="dataLineageAccordion">
                <!-- Original Data -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingOriginalData">
                        <button class="accordion-button" type="button" data-bs-toggle="collapse" data-bs-target="#collapseOriginalData" aria-expanded="true" aria-controls="collapseOriginalData">
                            <i class="bi bi-database me-2"></i> Original Price Data
                        </button>
                    </h2>
                    <div id="collapseOriginalData" class="accordion-collapse collapse show" aria-labelledby="headingOriginalData" data-bs-parent="#dataLineageAccordion">
                        <div class="accordion-body">
                            {% if plots.original_data %}
                            <div id="original-data-plot-container"></div>
                            <script>
                                var originalDataPlot = {{ plots.original_data|safe }};
                                Plotly.newPlot('original-data-plot-container', originalDataPlot.data, originalDataPlot.layout, {responsive: true});
                            </script>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> Original price data plot not available.
                            </div>
                            {% endif %}
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" id="view-original-data-table">
                                    <i class="bi bi-table"></i> View Data Table
                                </button>
                                <button class="btn btn-outline-success btn-sm" id="export-original-data">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Returns Data -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingReturnsData">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseReturnsData" aria-expanded="false" aria-controls="collapseReturnsData">
                            <i class="bi bi-arrow-up-right me-2"></i> Returns Data
                        </button>
                    </h2>
                    <div id="collapseReturnsData" class="accordion-collapse collapse" aria-labelledby="headingReturnsData" data-bs-parent="#dataLineageAccordion">
                        <div class="accordion-body">
                            {% if plots.returns_data %}
                            <div id="returns-data-plot-container"></div>
                            <script>
                                var returnsDataPlot = {{ plots.returns_data|safe }};
                                Plotly.newPlot('returns-data-plot-container', returnsDataPlot.data, returnsDataPlot.layout, {responsive: true});
                            </script>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> Returns data plot not available.
                            </div>
                            {% endif %}
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" id="view-returns-data-table">
                                    <i class="bi bi-table"></i> View Data Table
                                </button>
                                <button class="btn btn-outline-success btn-sm" id="export-returns-data">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Scaled Data -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingScaledData">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseScaledData" aria-expanded="false" aria-controls="collapseScaledData">
                            <i class="bi bi-arrows-expand me-2"></i> Scaled Data (for GARCH)
                        </button>
                    </h2>
                    <div id="collapseScaledData" class="accordion-collapse collapse" aria-labelledby="headingScaledData" data-bs-parent="#dataLineageAccordion">
                        <div class="accordion-body">
                            {% if plots.scaled_data %}
                            <div id="scaled-data-plot-container"></div>
                            <script>
                                var scaledDataPlot = {{ plots.scaled_data|safe }};
                                Plotly.newPlot('scaled-data-plot-container', scaledDataPlot.data, scaledDataPlot.layout, {responsive: true});
                            </script>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> Scaled data plot not available.
                            </div>
                            {% endif %}
                            <div class="mt-3">
                                <button class="btn btn-outline-primary btn-sm" id="view-scaled-data-table">
                                    <i class="bi bi-table"></i> View Data Table
                                </button>
                                <button class="btn btn-outline-success btn-sm" id="export-scaled-data">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- ARIMA Forecasts -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingArimaForecast">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseArimaForecast" aria-expanded="false" aria-controls="collapseArimaForecast">
                            <i class="bi bi-graph-up-arrow me-2"></i> ARIMA Forecasts
                        </button>
                    </h2>
                    <div id="collapseArimaForecast" class="accordion-collapse collapse" aria-labelledby="headingArimaForecast" data-bs-parent="#dataLineageAccordion">
                        <div class="accordion-body">
                            {% if plots.arima_forecast %}
                            <div id="arima-forecast-plot-container"></div>
                            <script>
                                var arimaForecastPlot = {{ plots.arima_forecast|safe }};
                                Plotly.newPlot('arima-forecast-plot-container', arimaForecastPlot.data, arimaForecastPlot.layout, {responsive: true});
                            </script>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> ARIMA forecast plot not available.
                            </div>
                            {% endif %}
                            <div class="mt-3">
                                <button class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-info-circle"></i> ARIMA forecasts show predicted future values with confidence intervals
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- GARCH Volatility -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingGarchVolatility">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseGarchVolatility" aria-expanded="false" aria-controls="collapseGarchVolatility">
                            <i class="bi bi-lightning me-2"></i> GARCH Volatility Forecasts
                        </button>
                    </h2>
                    <div id="collapseGarchVolatility" class="accordion-collapse collapse" aria-labelledby="headingGarchVolatility" data-bs-parent="#dataLineageAccordion">
                        <div class="accordion-body">
                            {% if plots.garch_volatility %}
                            <div id="garch-volatility-plot-container"></div>
                            <script>
                                var garchVolatilityPlot = {{ plots.garch_volatility|safe }};
                                Plotly.newPlot('garch-volatility-plot-container', garchVolatilityPlot.data, garchVolatilityPlot.layout, {responsive: true});
                            </script>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> GARCH volatility plot not available.
                            </div>
                            {% endif %}
                            <div class="mt-3">
                                <button class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-info-circle"></i> GARCH volatility forecasts show expected risk levels over time
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Spillover Analysis -->
                <div class="accordion-item">
                    <h2 class="accordion-header" id="headingSpilloverPlot">
                        <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSpilloverPlot" aria-expanded="false" aria-controls="collapseSpilloverPlot">
                            <i class="bi bi-shuffle me-2"></i> Spillover Analysis
                        </button>
                    </h2>
                    <div id="collapseSpilloverPlot" class="accordion-collapse collapse" aria-labelledby="headingSpilloverPlot" data-bs-parent="#dataLineageAccordion">
                        <div class="accordion-body">
                            {% if plots.spillover_heatmap %}
                            <div id="spillover-heatmap-plot-container"></div>
                            <script>
                                var spilloverHeatmapPlot = {{ plots.spillover_heatmap|safe }};
                                Plotly.newPlot('spillover-heatmap-plot-container', spilloverHeatmapPlot.data, spilloverHeatmapPlot.layout, {responsive: true});
                            </script>
                            {% else %}
                            <div class="alert alert-warning">
                                <i class="bi bi-exclamation-triangle"></i> Spillover analysis plot not available.
                            </div>
                            {% endif %}
                            <div class="mt-3">
                                <button class="btn btn-outline-info btn-sm">
                                    <i class="bi bi-info-circle"></i> Spillover analysis shows how shocks spread between assets
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
            {% else %}
            <div class="alert alert-warning">
                <i class="bi bi-exclamation-triangle"></i>
                <strong>No plots available:</strong> Server-side plot generation failed or no data was provided.
                <br><small>Please check the Raw Data tab to see if analysis results are available.</small>
            </div>
            {% endif %}
        </div>

        <!-- Statistical Tests Tab -->
        <div class="tab-pane fade {% if active_tab == 'statistical-tests' %}show active{% endif %}" id="statistical-tests" role="tabpanel" aria-labelledby="statistical-tests-tab">
            <!-- Stationarity Tests -->
            <div class="card mb-4">
                <div class="card-header">
                    <button class="btn btn-link text-decoration-none w-100 text-start p-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapseStationarity" aria-expanded="true" aria-controls="collapseStationarity">
                        <h5 class="card-title mb-0"><i class="bi bi-activity me-2"></i> Stationarity Tests (ADF)</h5>
                    </button>
                </div>
                <div id="collapseStationarity" class="collapse show">
                    <div class="card-body">
                        <div id="stationarity-results-container">
                            <!-- Per-symbol stationarity results -->
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- Series Statistics -->
            <div class="card mb-4">
                <div class="card-header">
                    <button class="btn btn-link text-decoration-none w-100 text-start p-0" type="button" data-bs-toggle="collapse" data-bs-target="#collapseSeriesStats" aria-expanded="false" aria-controls="collapseSeriesStats">
                        <h5 class="card-title mb-0"><i class="bi bi-bar-chart me-2"></i> Series Statistics</h5>
                    </button>
                </div>
                <div id="collapseSeriesStats" class="collapse">
                    <div class="card-body">
                        <div id="series-statistics-container">
                            <!-- Series statistics table -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Models & Forecasts Tab -->
        <div class="tab-pane fade {% if active_tab == 'models' %}show active{% endif %}" id="models" role="tabpanel" aria-labelledby="models-tab">
        </div>

        {% if spillover_results %}
        <div class="tab-pane fade {% if active_tab == 'spillover' %}show active{% endif %}" id="spillover" role="tabpanel" aria-labelledby="spillover-tab">
        </div>
        {% endif %}

        <!-- Granger Causality Tab -->
        <div class="tab-pane fade {% if active_tab == 'granger-causality' %}show active{% endif %}" id="granger-causality" role="tabpanel" aria-labelledby="granger-causality-tab">
        </div>

        <!-- Raw Data Tab -->
        <div class="tab-pane fade {% if active_tab == 'raw-data' %}show active{% endif %}" id="raw-data-pane" role="tabpanel" aria-labelledby="raw-data-tab">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-table"></i> Raw Data</h5>
                </div>
                <div class="card-body">
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle-fill"></i>
                        This section provides access to the raw underlying data at various stages of the analysis pipeline. You can inspect the data in tabular format and export it as a CSV file.
                    </div>
                    <div id="raw-data-container"></div>
                </div>
            </div>
        </div>

        <!-- Next Step -->
        <div class="tab-pane fade {% if active_tab == 'next-step' %}show active{% endif %}" id="next-step-pane" role="tabpanel" aria-labelledby="next-step-tab">
            <div class="card">
                <div class="card-header">
                    <h5 class="card-title mb-0"><i class="bi bi-arrow-right-circle"></i> Next Step</h5>
                </div>
                <div class="card-body">
                    <p>Based on the analysis, you can choose to continue to the next iteration.</p>
                    <form id="next-iteration-form" method="post" action="{% url 'timeseries:iterate' %}">
                        {% csrf_token %}
                        <input type="hidden" name="session_id" value="{{ session_id }}">
                        <button type="submit" class="btn btn-primary">Continue to iterate?</button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
    // Get results from sessionStorage instead of Django context
    const analysisResults = sessionStorage.getItem('analysisResults');
    let resultsData = null;
    
    if (analysisResults) {
        try {
            resultsData = JSON.parse(analysisResults);
            // Show results container and hide no-results message
            document.getElementById('results-container').style.display = 'block';
            document.getElementById('no-results').style.display = 'none';
            
            // Populate the page with results data
            populateResultsPage(resultsData);
        } catch (error) {
            console.error('Error parsing analysis results:', error);
            document.getElementById('no-results').style.display = 'block';
            document.getElementById('results-container').style.display = 'none';
        }
    } else {
        // No results found in sessionStorage
        document.getElementById('no-results').style.display = 'block';
        document.getElementById('results-container').style.display = 'none';
    }
    
    function populateResultsPage(data) {
        // Populate various sections with the results data
        // This function will need to be implemented based on your data structure
        console.log('Analysis results:', data);
        
        // For now, just display the raw JSON in the raw data tab
        const rawDataContainer = document.getElementById('raw-data-container');
        if (rawDataContainer) {
            rawDataContainer.innerHTML = `<pre style="background-color: #f8f9fa; padding: 1rem; border-radius: 0.375rem;">${JSON.stringify(data, null, 2)}</pre>`;
        }
        
        // Set up download functionality
        setupDownloadFunctionality(data);
    }
    
    function setupDownloadFunctionality(data) {
        const downloadBtn = document.getElementById('download-api-response-btn');
        const viewBtn = document.getElementById('view-api-response-btn');
        const copyBtn = document.getElementById('copy-json-btn');
        
        if (downloadBtn) {
            downloadBtn.addEventListener('click', function() {
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `analysis_results_${new Date().toISOString().slice(0, 19).replace(/:/g, '-')}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
            });
        }
        
        if (viewBtn) {
            viewBtn.addEventListener('click', function() {
                const jsonContent = document.getElementById('json-content');
                if (jsonContent) {
                    jsonContent.textContent = JSON.stringify(data, null, 2);
                }
                const modal = new bootstrap.Modal(document.getElementById('jsonModal'));
                modal.show();
            });
        }
        
        if (copyBtn) {
            copyBtn.addEventListener('click', function() {
                const jsonContent = document.getElementById('json-content').textContent;
                navigator.clipboard.writeText(jsonContent).then(() => {
                    copyBtn.textContent = 'Copied!';
                    setTimeout(() => {
                        copyBtn.textContent = 'Copy to Clipboard';
                    }, 2000);
                });
            });
        }
    }
</script>
{% endblock %}
