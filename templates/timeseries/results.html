<!--
# === FILE META OPENING ===
# file: ./timeseries-frontend/templates/timeseries/results.html
# role: frontend
# desc: main results page template that displays server-side processed analysis results with minimal JavaScript
# === FILE META CLOSING ===
-->

{% extends 'base.html' %}
{% load static %}
{% load dict_extras %}

{% block title %}Lab:Results{% endblock %}

{% block extra_css %}
<style>
    /* Hide HTMX indicators by default */
    .htmx-indicator {
        display: none;
    }
    
    /* Show HTMX indicators only during requests */
    .htmx-request .htmx-indicator {
        display: inline-block;
    }
    
    /* Additional styling for better UX */
    .plotly-chart {
        min-height: 400px;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Analysis Results</h1>
    <div class="btn-group" role="group">
        <a href="{% url 'timeseries:download_api_response' %}" class="btn btn-outline-primary">
            <i class="bi bi-download"></i> Download API response
        </a>
        <a href="{% url 'timeseries:view_api_response_popup' %}" target="_blank" class="btn btn-outline-secondary">
            <i class="bi bi-eye"></i> View API response
        </a>
    </div>
</div>

{% if no_results %}
<div class="alert alert-warning">
    <h4><i class="bi bi-exclamation-triangle"></i> No Results Found</h4>
    <p>{{ error_message }}</p>
    <a href="{% url 'timeseries:analysis' %}" class="btn btn-primary">Go to Analysis</a>
</div>
{% else %}

<!-- Main Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="resultsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'overview' %}active{% endif %}" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" 
                type="button" role="tab" aria-controls="overview" aria-selected="{% if active_tab == 'overview' %}true{% else %}false{% endif %}">
            <i class="bi bi-speedometer2"></i> Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'execution-config' %}active{% endif %}" id="execution-config-tab" data-bs-toggle="tab" data-bs-target="#execution-config" 
                type="button" role="tab" aria-controls="execution-config" aria-selected="{% if active_tab == 'execution-config' %}true{% else %}false{% endif %}">
            <i class="bi bi-gear"></i> Configuration
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'time-series' %}active{% endif %}" id="time-series-tab" data-bs-toggle="tab" data-bs-target="#time-series" 
                type="button" role="tab" aria-controls="time-series" aria-selected="{% if active_tab == 'time-series' %}true{% else %}false{% endif %}">
            <i class="bi bi-graph-up"></i> Series
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'statistical-tests' %}active{% endif %}" id="statistical-tests-tab" data-bs-toggle="tab" data-bs-target="#statistical-tests" 
                type="button" role="tab" aria-controls="statistical-tests" aria-selected="{% if active_tab == 'statistical-tests' %}true{% else %}false{% endif %}">
            <i class="bi bi-calculator"></i> Statistical Tests
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'arima' %}active{% endif %}" id="arima-tab" data-bs-toggle="tab" data-bs-target="#arima" 
                type="button" role="tab" aria-controls="arima" aria-selected="{% if active_tab == 'arima' %}true{% else %}false{% endif %}">
            <i class="bi bi-graph-up-arrow"></i> ARIMA
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'garch' %}active{% endif %}" id="garch-tab" data-bs-toggle="tab" data-bs-target="#garch" 
                type="button" role="tab" aria-controls="garch" aria-selected="{% if active_tab == 'garch' %}true{% else %}false{% endif %}">
            <i class="bi bi-lightning"></i> GARCH
        </button>
    </li>
    {% if spillover_enabled %}
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'spillover' %}active{% endif %}" id="spillover-tab" data-bs-toggle="tab" data-bs-target="#spillover" 
                type="button" role="tab" aria-controls="spillover" aria-selected="{% if active_tab == 'spillover' %}true{% else %}false{% endif %}">
            <i class="bi bi-arrows-angle-expand"></i> Spillover Analysis
        </button>
    </li>
    {% endif %}
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'granger-causality' %}active{% endif %}" id="granger-causality-tab" data-bs-toggle="tab" data-bs-target="#granger-causality"
                type="button" role="tab" aria-controls="granger-causality" aria-selected="{% if active_tab == 'granger-causality' %}true{% else %}false{% endif %}">
            <i class="bi bi-arrow-through-heart"></i> Causality
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'explainer' %}active{% endif %}" id="explainer-tab" data-bs-toggle="tab" data-bs-target="#explainer" 
                type="button" role="tab" aria-controls="explainer" aria-selected="{% if active_tab == 'explainer' %}true{% else %}false{% endif %}">
            <i class="bi bi-question-circle"></i> Background
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'data-lineage' %}active{% endif %}" id="data-lineage-tab" data-bs-toggle="tab" data-bs-target="#data-lineage-pane" 
                type="button" role="tab" aria-controls="data-lineage-pane" aria-selected="{% if active_tab == 'data-lineage' %}true{% else %}false{% endif %}">
            <i class="bi bi-diagram-3"></i> Provenance
        </button>
    </li>
</ul>

<div class="tab-content" id="resultsTabsContent">
    
    <!-- Overview Tab -->
    <div class="tab-pane fade {% if active_tab == 'overview' %}show active{% endif %}" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <div class="row">
            <div class="col-12">
                <!-- Executive Summary Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-briefcase"></i> Executive Summary</h5>
                    </div>
                    <div class="card-body">
                        {% if executive_summary.stationarity_summary %}
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-activity"></i> Stationarity Analysis Summary</h6>
                                </div>
                                <div class="card-body">
                                    {% for symbol, details in executive_summary.stationarity_summary.items %}
                                        <div class="border-start border-primary border-3 ps-3 mb-3">
                                            <h6 class="text-primary mb-2">{{ symbol|upper }}</h6>
                                            <ul class="mb-0">
                                                {% for key, value in details.items %}
                                                    <li><strong>{{ key|title|replace_underscore }}:</strong> {{ value }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if executive_summary.executive_summary %}
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-graph-up-arrow"></i> ARIMA Analysis Summary</h6>
                                </div>
                                <div class="card-body">
                                    {% for symbol, details in executive_summary.executive_summary.items %}
                                        <div class="border-start border-success border-3 ps-3 mb-3">
                                            <h6 class="text-success mb-2">{{ symbol|upper }}</h6>
                                            <ul class="mb-0">
                                                {% for key, value in details.items %}
                                                    <li><strong>{{ key|title|replace_underscore }}:</strong> {{ value }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if executive_summary.garch_summary %}
                            <div class="card mb-3">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="bi bi-lightning"></i> GARCH Analysis Summary</h6>
                                </div>
                                <div class="card-body">
                                    {% for symbol, details in executive_summary.garch_summary.items %}
                                        <div class="border-start border-warning border-3 ps-3 mb-3">
                                            <h6 class="text-warning mb-2">{{ symbol|upper }}</h6>
                                            <ul class="mb-0">
                                                {% for key, value in details.items %}
                                                    <li><strong>{{ key|title|replace_underscore }}:</strong> {{ value }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Configuration Tab -->
    <div class="tab-pane fade {% if active_tab == 'execution-config' %}show active{% endif %}" id="execution-config" role="tabpanel" aria-labelledby="execution-config-tab">
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle"></i>
            <strong>Analysis Configuration:</strong> This section shows all the parameters and settings that were used to execute this analysis.
        </div>
        
        <!-- Data Source Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-database"></i> Data Source Configuration</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.data_source %}
                    <table class="table table-sm">
                        {% for key, value in execution_configuration.data_source.items %}
                        <tr>
                            <td><strong>{{ key|title }}:</strong></td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">No data source configuration available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Model Configurations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-cpu"></i> Model Configurations</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.model_configurations %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-graph-up-arrow"></i> ARIMA Parameters</h6>
                            {% if execution_configuration.model_configurations.arima_params %}
                                <table class="table table-sm">
                                    {% for key, value in execution_configuration.model_configurations.arima_params.items %}
                                    <tr>
                                        <td><strong>{{ key }}:</strong></td>
                                        <td>{{ value }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-lightning"></i> GARCH Parameters</h6>
                            {% if execution_configuration.model_configurations.garch_params %}
                                <table class="table table-sm">
                                    {% for key, value in execution_configuration.model_configurations.garch_params.items %}
                                    <tr>
                                        <td><strong>{{ key }}:</strong></td>
                                        <td>{{ value }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Data Processing Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-sliders"></i> Data Processing Configuration</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.data_processing %}
                    <table class="table table-sm">
                        {% for key, value in execution_configuration.data_processing.items %}
                        <tr>
                            <td><strong>{{ key|title|replace_underscore }}:</strong></td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">No data processing configuration available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Spillover Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-shuffle"></i> Spillover Configuration</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.spillover_configuration %}
                    <table class="table table-sm">
                        {% for key, value in execution_configuration.spillover_configuration.items %}
                        <tr>
                            <td><strong>{{ key|title|replace_underscore }}:</strong></td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">No spillover configuration available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Execution Metadata -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-clock-history"></i> Execution Metadata</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.execution_metadata %}
                    <table class="table table-sm">
                        {% for key, value in execution_configuration.execution_metadata.items %}
                        <tr>
                            <td><strong>{{ key|title|replace_underscore }}:</strong></td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">No execution metadata available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Time Series Tab -->
    <div class="tab-pane fade {% if active_tab == 'time-series' %}show active{% endif %}" id="time-series" role="tabpanel" aria-labelledby="time-series-tab">
        <!-- Original Data Visualization -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-graph-up me-2"></i> Original Price Data Visualization</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Time Series Analysis:</strong> This section provides interactive visualizations of the original price data used in the analysis. The chart below shows price movements over time for all analyzed symbols.
                </div>
                
                {% if plots.original_data_stats %}
                    <div id="original-data-plot" class="plotly-chart"></div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            try {
                                var plotData = {{ plots.original_data_stats|safe }};
                                Plotly.newPlot('original-data-plot', plotData.data, plotData.layout, {
                                    responsive: true,
                                    displayModeBar: true,
                                    displaylogo: false,
                                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                                });
                            } catch (error) {
                                console.error('Error rendering original data plot:', error);
                                document.getElementById('original-data-plot').innerHTML = 
                                    '<div class="alert alert-warning">Error loading chart. Please try refreshing the page.</div>';
                            }
                        });
                    </script>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Chart Not Available:</strong> Original data visualization could not be generated. This may be due to missing data or processing issues.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Returns Data Visualization -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-activity me-2"></i> Returns Data Visualization</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Returns Analysis:</strong> Logarithmic returns calculated from the original price data. Returns show the percentage change in prices and are used for risk analysis and modeling.
                </div>
                
                {% if plots.returns_data_plot %}
                    <div id="returns-data-plot" class="plotly-chart"></div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            try {
                                var plotData = {{ plots.returns_data_plot|safe }};
                                Plotly.newPlot('returns-data-plot', plotData.data, plotData.layout, {
                                    responsive: true,
                                    displayModeBar: true,
                                    displaylogo: false,
                                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                                });
                            } catch (error) {
                                console.error('Error rendering returns plot:', error);
                                document.getElementById('returns-data-plot').innerHTML = 
                                    '<div class="alert alert-warning">Error loading chart. Please try refreshing the page.</div>';
                            }
                        });
                    </script>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Chart Not Available:</strong> Returns data visualization could not be generated.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Scaled Data Visualization -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-arrows-fullscreen me-2"></i> Scaled Data Visualization</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Scaled Data:</strong> Standardized returns data prepared for GARCH modeling. This normalization helps ensure model stability and comparability across different assets.
                </div>
                
                {% if plots.scaled_data_plot %}
                    <div id="scaled-data-plot" class="plotly-chart"></div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            try {
                                var plotData = {{ plots.scaled_data_plot|safe }};
                                Plotly.newPlot('scaled-data-plot', plotData.data, plotData.layout, {
                                    responsive: true,
                                    displayModeBar: true,
                                    displaylogo: false,
                                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                                });
                            } catch (error) {
                                console.error('Error rendering scaled data plot:', error);
                                document.getElementById('scaled-data-plot').innerHTML = 
                                    '<div class="alert alert-warning">Error loading chart. Please try refreshing the page.</div>';
                            }
                        });
                    </script>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Chart Not Available:</strong> Scaled data visualization could not be generated.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Pre-GARCH Data Visualization -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-box-arrow-in-right me-2"></i> Pre-GARCH Data Visualization</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Pre-GARCH Data:</strong> Data prepared and ready for GARCH model input. This represents the final preprocessing step before volatility modeling.
                </div>
                
                {% if plots.pre_garch_plot %}
                    <div id="pre-garch-plot" class="plotly-chart"></div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            try {
                                var plotData = {{ plots.pre_garch_plot|safe }};
                                Plotly.newPlot('pre-garch-plot', plotData.data, plotData.layout, {
                                    responsive: true,
                                    displayModeBar: true,
                                    displaylogo: false,
                                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                                });
                            } catch (error) {
                                console.error('Error rendering pre-GARCH plot:', error);
                                document.getElementById('pre-garch-plot').innerHTML = 
                                    '<div class="alert alert-warning">Error loading chart. Please try refreshing the page.</div>';
                            }
                        });
                    </script>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Chart Not Available:</strong> Pre-GARCH data visualization could not be generated.
                    </div>
                {% endif %}
            </div>
        </div>

        <!-- Post-GARCH Data Visualization -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-box-arrow-right me-2"></i> Post-GARCH Data Visualization</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-3">
                    <i class="bi bi-info-circle"></i>
                    <strong>Post-GARCH Data:</strong> Data after GARCH volatility modeling and residual extraction. This shows the final processed data with volatility clustering effects captured.
                </div>
                
                {% if plots.post_garch_plot %}
                    <div id="post-garch-plot" class="plotly-chart"></div>
                    <script>
                        document.addEventListener('DOMContentLoaded', function() {
                            try {
                                var plotData = {{ plots.post_garch_plot|safe }};
                                Plotly.newPlot('post-garch-plot', plotData.data, plotData.layout, {
                                    responsive: true,
                                    displayModeBar: true,
                                    displaylogo: false,
                                    modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                                });
                            } catch (error) {
                                console.error('Error rendering post-GARCH plot:', error);
                                document.getElementById('post-garch-plot').innerHTML = 
                                    '<div class="alert alert-warning">Error loading chart. Please try refreshing the page.</div>';
                            }
                        });
                    </script>
                {% else %}
                    <div class="alert alert-info">
                        <i class="bi bi-info-circle"></i>
                        <strong>Chart Not Available:</strong> Post-GARCH data visualization could not be generated.
                    </div>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Statistical Tests Tab -->
    <div class="tab-pane fade {% if active_tab == 'statistical-tests' %}show active{% endif %}" id="statistical-tests" role="tabpanel" aria-labelledby="statistical-tests-tab">
        <!-- Stationarity Tests -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-activity me-2"></i> Stationarity Tests (ADF)</h5>
            </div>
            <div class="card-body">
                {% if stationarity_results.all_symbols_stationarity %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Status</th>
                                    <th>Test Statistic</th>
                                    <th>P-Value</th>
                                    <th>Critical Values (1%, 5%, 10%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for symbol, test in stationarity_results.all_symbols_stationarity.items %}
                                    <tr>
                                        <td><strong>{{ symbol }}</strong></td>
                                        <td>
                                            {% if test.is_stationary %}
                                                <span class="badge bg-success">Stationary</span>
                                            {% else %}
                                                <span class="badge bg-warning">Non-Stationary</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ test.adf_statistic|floatformat:4 }}</td>
                                        <td>{{ test.p_value|floatformat:4 }}</td>
                                        <td>
                                            {% if test.critical_values %}
                                                {% for key, value in test.critical_values.items %}
                                                    {{ value|floatformat:3 }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No stationarity test results available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Series Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-bar-chart me-2"></i> Series Statistics</h5>
            </div>
            <div class="card-body">
                {% if stationarity_results.series_stats %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Count</th>
                                    <th>Mean</th>
                                    <th>Std Dev</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Skewness</th>
                                    <th>Kurtosis</th>
                                    <th>Ann. Vol</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for symbol, stats in stationarity_results.series_stats.items %}
                                <tr>
                                    <td><strong>{{ symbol }}</strong></td>
                                    <td>{{ stats.n|default:"-" }}</td>
                                    <td>{{ stats.mean|floatformat:6|default:"-" }}</td>
                                    <td>{{ stats.std|floatformat:6|default:"-" }}</td>
                                    <td>{{ stats.min|floatformat:6|default:"-" }}</td>
                                    <td>{{ stats.max|floatformat:6|default:"-" }}</td>
                                    <td>{{ stats.skew|floatformat:3|default:"-" }}</td>
                                    <td>{{ stats.kurt|floatformat:3|default:"-" }}</td>
                                    <td>{{ stats.annualized_vol|floatformat:4|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No series statistics available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ARIMA Tab -->
    <div class="tab-pane fade {% if active_tab == 'arima' %}show active{% endif %}" id="arima" role="tabpanel" aria-labelledby="arima-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-graph-up-arrow"></i> ARIMA Model Results</h5>
            </div>
            <div class="card-body">
                {% if arima_results %}
                    {% for symbol, arima in arima_results.items %}
                        <div class="border rounded p-3 mb-3">
                            <h6><strong>{{ symbol }}</strong></h6>
                            
                            {% if arima.interpretation.executive_summary %}
                                <div class="alert alert-info">
                                    <strong>Executive Summary:</strong> {{ arima.interpretation.executive_summary.bottom_line }}
                                </div>
                            {% endif %}
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Model Summary</h6>
                                    {% if arima.summary %}
                                        <table class="table table-sm">
                                            <tr><td><strong>Model:</strong></td><td>{{ arima.summary.model_specification|default:"-" }}</td></tr>
                                            <tr><td><strong>AIC:</strong></td><td>{{ arima.summary.aic|floatformat:2|default:"-" }}</td></tr>
                                            <tr><td><strong>BIC:</strong></td><td>{{ arima.summary.bic|floatformat:2|default:"-" }}</td></tr>
                                            <tr><td><strong>HQIC:</strong></td><td>{{ arima.summary.hqic|floatformat:2|default:"-" }}</td></tr>
                                            <tr><td><strong>Log Likelihood:</strong></td><td>{{ arima.summary.log_likelihood|floatformat:2|default:"-" }}</td></tr>
                                            <tr><td><strong>Sample Size:</strong></td><td>{{ arima.summary.sample_size|default:"-" }}</td></tr>
                                        </table>
                                        <h6 class="mt-3">Parameters</h6>
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Parameter</th>
                                                    <th>Value</th>
                                                    <th>P-Value</th>
                                                    <th>Significance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for param in param_list %}
                                                    <tr>
                                                        <td>{{ param }}</td>
                                                        <td>{{ arima.summary.parameters|lookup:param|floatformat:4|default:"-" }}</td>
                                                        <td>{{ arima.summary.parameter_pvalues|lookup:param|floatformat:4|default:"-" }}</td>
                                                        <td>{{ arima.summary.parameter_significance|lookup:param|default:"-" }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% if arima.summary.residual_statistics %}
                                        <h6 class="mt-3">Residual Statistics</h6>
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Statistic</th>
                                                    <th>Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for stat, value in arima.summary.residual_statistics.items %}
                                                    <tr>
                                                        <td>{{ stat|title|replace_underscore }}</td>
                                                        <td>{{ value|floatformat:4|default:"-" }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6>Forecast Summary</h6>
                                    {% if arima.forecast %}
                                        <table class="table table-sm">
                                            <tr><td><strong>Forecast Steps:</strong></td><td>{{ arima.forecast.forecast_steps|default:"-" }}</td></tr>
                                            <tr><td><strong>Method:</strong></td><td>{{ arima.forecast.forecast_method|default:"-" }}</td></tr>
                                            {% if arima.forecast.point_forecasts %}
                                                <tr><td><strong>Next Value:</strong></td><td>{{ arima.forecast.point_forecasts.0|floatformat:4 }}</td></tr>
                                            {% endif %}
                                        </table>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if arima.interpretation.key_findings %}
                                <div class="mt-2">
                                    <h6>Key Findings</h6>
                                    {% for finding_type, finding_text in arima.interpretation.key_findings.items %}
                                        {% if finding_text %}
                                            <div class="mb-2">
                                                <strong>{{ finding_type|title|replace_underscore }}:</strong>
                                                {% if finding_text is string %}
                                                    <span>{{ finding_text }}</span>
                                                {% elif finding_text.items %}
                                                    <ul class="mb-0">
                                                        {% for k, v in finding_text.items %}
                                                            <li><strong>{{ k|title|replace_underscore }}:</strong> {{ v }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span>{{ finding_text }}</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No ARIMA results available.</p>
                {% endif %}
            </div>
        </div>

        <!-- ARIMA Analysis Visualizations -->
        {% if plots %}
            {% for symbol in symbols %}
                {% with plot_key='arima_analysis_'|add:symbol|lower %}
                    {% if plots|lookup:plot_key %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-graph-up-arrow me-2"></i> 
                                    {{ symbol|upper }} - ARIMA Analysis Visualization
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>ARIMA Components:</strong> This visualization shows the complete ARIMA analysis for {{ symbol|upper }}, including fitted values vs actual data, residuals analysis, filtered series (with predictable component removed), and forecast projections.
                                    {% if arima_results|lookup:symbol.forecast.forecast_method %}
                                        <br><strong>Forecast Method:</strong> {{ arima_results|lookup:symbol.forecast.forecast_method }}
                                    {% endif %}
                                </div>
                                
                                <div id="arima-plot-{{ symbol|lower }}" class="plotly-chart"></div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        try {
                                            var plotData = {{ plots|lookup:plot_key|safe }};
                                            Plotly.newPlot('arima-plot-{{ symbol|lower }}', plotData.data, plotData.layout, {
                                                responsive: true,
                                                displayModeBar: true,
                                                displaylogo: false,
                                                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                                            });
                                        } catch (error) {
                                            console.error('Error rendering ARIMA plot for {{ symbol }}:', error);
                                            document.getElementById('arima-plot-{{ symbol|lower }}').innerHTML = 
                                                '<div class="alert alert-warning">Error loading ARIMA chart for {{ symbol }}. Please try refreshing the page.</div>';
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endfor %}
        {% endif %}
        
    </div>

    <!-- GARCH Tab -->
    <div class="tab-pane fade {% if active_tab == 'garch' %}show active{% endif %}" id="garch" role="tabpanel" aria-labelledby="garch-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-lightning"></i> GARCH Model Results</h5>
            </div>
            <div class="card-body">
                {% if garch_results %}
                    {% for symbol, garch in garch_results.items %}
                        <div class="border rounded p-3 mb-3">
                            <h6><strong>{{ symbol }}</strong></h6>
                            
                            {% if garch.interpretation.executive_summary %}
                                <div class="alert alert-warning">
                                    <strong>Volatility Summary:</strong> {{ garch.interpretation.executive_summary.bottom_line }}
                                </div>
                            {% endif %}
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Model Summary</h6>
                                    {% if garch.summary %}
                                        <div class="bg-light p-2 rounded mb-3">
                                            <small class="font-monospace">{{ garch.summary|truncatechars:400 }}</small>
                                        </div>
                                        
                                        <!-- Extract key model information if available -->
                                        {% if garch.interpretation.technical_details.model_specification %}
                                            <table class="table table-sm">
                                                <tr><td><strong>Model Order:</strong></td><td>{{ garch.interpretation.technical_details.model_specification.order|default:"-" }}</td></tr>
                                                <tr><td><strong>Omega (ω):</strong></td><td>{{ garch.interpretation.technical_details.model_specification.omega|floatformat:6|default:"-" }}</td></tr>
                                                <tr><td><strong>Alpha (α):</strong></td><td>{{ garch.interpretation.technical_details.model_specification.alpha|floatformat:6|default:"-" }}</td></tr>
                                                <tr><td><strong>Beta (β):</strong></td><td>{{ garch.interpretation.technical_details.model_specification.beta|floatformat:6|default:"-" }}</td></tr>
                                            </table>
                                            
                                            {% if garch.interpretation.technical_details.volatility_mechanics %}
                                                <h6 class="mt-3">Volatility Mechanics</h6>
                                                <table class="table table-bordered table-sm">
                                                    <thead>
                                                        <tr>
                                                            <th>Metric</th>
                                                            <th>Value</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        <tr>
                                                            <td>Persistence</td>
                                                            <td>{{ garch.interpretation.technical_details.volatility_mechanics.persistence|floatformat:4|default:"-" }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Half Life</td>
                                                            <td>{{ garch.interpretation.technical_details.volatility_mechanics.half_life|floatformat:2|default:"-" }}</td>
                                                        </tr>
                                                        <tr>
                                                            <td>Unconditional Variance</td>
                                                            <td>{{ garch.interpretation.technical_details.volatility_mechanics.unconditional_variance|floatformat:6|default:"-" }}</td>
                                                        </tr>
                                                    </tbody>
                                                </table>
                                            {% endif %}
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted">Model summary not available</p>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6>Volatility Forecast</h6>
                                    {% if garch.forecast %}
                                        <table class="table table-sm">
                                            <tr><td><strong>Forecast Periods:</strong></td><td>{{ garch.forecast|length }}</td></tr>
                                            {% if garch.forecast.0 %}
                                                <tr><td><strong>Next Period Volatility:</strong></td><td>{{ garch.forecast.0|floatformat:6 }}</td></tr>
                                            {% endif %}
                                            {% if garch.interpretation.technical_details.forecast_statistics %}
                                                <tr><td><strong>Mean Forecast:</strong></td><td>{{ garch.interpretation.technical_details.forecast_statistics.mean_forecast|floatformat:6|default:"-" }}</td></tr>
                                                <tr><td><strong>Forecast Volatility:</strong></td><td>{{ garch.interpretation.technical_details.forecast_statistics.forecast_volatility|floatformat:6|default:"-" }}</td></tr>
                                                <tr><td><strong>Forecast Range:</strong></td><td>{{ garch.interpretation.technical_details.forecast_statistics.forecast_range|default:"-" }}</td></tr>
                                                <tr><td><strong>Total Change:</strong></td><td>{{ garch.interpretation.technical_details.forecast_statistics.total_change|floatformat:4|default:"-" }}</td></tr>
                                            {% endif %}
                                        </table>
                                        
                                        {% if garch.forecast|length > 1 %}
                                            <h6 class="mt-3">Forecast Values</h6>
                                            <div class="table-responsive" style="max-height: 200px; overflow-y: auto;">
                                                <table class="table table-sm table-striped">
                                                    <thead>
                                                        <tr>
                                                            <th>Period</th>
                                                            <th>Volatility</th>
                                                        </tr>
                                                    </thead>
                                                    <tbody>
                                                        {% for forecast_val in garch.forecast %}
                                                            <tr>
                                                                <td>{{ forloop.counter }}</td>
                                                                <td>{{ forecast_val|floatformat:6 }}</td>
                                                            </tr>
                                                        {% endfor %}
                                                    </tbody>
                                                </table>
                                            </div>
                                        {% endif %}
                                    {% else %}
                                        <p class="text-muted">No forecast data available</p>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if garch.interpretation.key_findings %}
                                <div class="mt-3">
                                    <h6>Key Findings</h6>
                                    {% for finding_type, finding_data in garch.interpretation.key_findings.items %}
                                        {% if finding_data %}
                                            <div class="mb-3">
                                                <strong>{{ finding_type|title|replace_underscore }}:</strong>
                                                {% if finding_data is string %}
                                                    <span>{{ finding_data }}</span>
                                                {% elif finding_data.items %}
                                                    <ul class="mb-0">
                                                        {% for k, v in finding_data.items %}
                                                            <li><strong>{{ k|title|replace_underscore }}:</strong> {{ v }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span>{{ finding_data }}</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                            
                            {% if garch.interpretation.technical_details %}
                                <div class="mt-3">
                                    <h6>Technical Details</h6>
                                    <div class="row">
                                        {% if garch.interpretation.technical_details.model_specification.justification %}
                                            <div class="col-12 mb-2">
                                                <div class="alert alert-light">
                                                    <strong>Model Specification:</strong> {{ garch.interpretation.technical_details.model_specification.justification }}
                                                </div>
                                            </div>
                                        {% endif %}
                                        {% if garch.interpretation.technical_details.volatility_mechanics.justification %}
                                            <div class="col-12 mb-2">
                                                <div class="alert alert-light">
                                                    <strong>Volatility Mechanics:</strong> {{ garch.interpretation.technical_details.volatility_mechanics.justification }}
                                                </div>
                                            </div>
                                        {% endif %}
                                    </div>
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No GARCH results available.</p>
                {% endif %}
            </div>
        </div>

        <!-- GARCH Analysis Visualizations -->
        {% if plots %}
            {% for symbol in symbols %}
                {% with plot_key='garch_analysis_'|add:symbol|lower %}
                    {% if plots|lookup:plot_key %}
                        <div class="card mb-4">
                            <div class="card-header">
                                <h5 class="card-title mb-0">
                                    <i class="bi bi-lightning me-2"></i> 
                                    {{ symbol|upper }} - GARCH Analysis Visualization
                                </h5>
                            </div>
                            <div class="card-body">
                                <div class="alert alert-info mb-3">
                                    <i class="bi bi-info-circle"></i>
                                    <strong>GARCH Components:</strong> This visualization shows the complete GARCH volatility analysis for {{ symbol|upper }}, including conditional volatility, standardized residuals, volatility clustering patterns, and volatility forecasts.
                                    {% if garch_results|lookup:symbol.interpretation.technical_details.model_specification.order %}
                                        <br><strong>Model Order:</strong> {{ garch_results|lookup:symbol.interpretation.technical_details.model_specification.order }}
                                    {% endif %}
                                </div>
                                
                                <div id="garch-plot-{{ symbol|lower }}" class="plotly-chart"></div>
                                <script>
                                    document.addEventListener('DOMContentLoaded', function() {
                                        try {
                                            var plotData = {{ plots|lookup:plot_key|safe }};
                                            Plotly.newPlot('garch-plot-{{ symbol|lower }}', plotData.data, plotData.layout, {
                                                responsive: true,
                                                displayModeBar: true,
                                                displaylogo: false,
                                                modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
                                            });
                                        } catch (error) {
                                            console.error('Error rendering GARCH plot for {{ symbol }}:', error);
                                            document.getElementById('garch-plot-{{ symbol|lower }}').innerHTML = 
                                                '<div class="alert alert-warning">Error loading GARCH chart for {{ symbol }}. Please try refreshing the page.</div>';
                                        }
                                    });
                                </script>
                            </div>
                        </div>
                    {% endif %}
                {% endwith %}
            {% endfor %}
        {% endif %}
    </div>

    <!-- Spillover Analysis Tab -->
    {% if spillover_enabled %}
    <div class="tab-pane fade {% if active_tab == 'spillover' %}show active{% endif %}" id="spillover" role="tabpanel" aria-labelledby="spillover-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-arrows-angle-expand"></i> Spillover Analysis Results</h5>
            </div>
            <div class="card-body">
                {% if spillover_results %}
                    {% if spillover_results.total_spillover_index %}
                        <div class="alert alert-primary">
                            <h6><strong>Total Spillover Index:</strong> {{ spillover_results.total_spillover_index|floatformat:2 }}%</h6>
                            <p>This indicates the percentage of forecast error variance that comes from spillovers between assets.</p>
                        </div>
                    {% endif %}
                    
                    {% if spillover_results.interpretation %}
                        <div class="alert alert-info">
                            <strong>Interpretation:</strong> {{ spillover_results.interpretation }}
                        </div>
                    {% endif %}
                    
                    {% if spillover_results.spillover_table_data %}
                        <h6>Directional Spillover</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Spillover TO Others (%)</th>
                                        <th>Spillover FROM Others (%)</th>
                                        <th>Net Spillover (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in spillover_results.spillover_table_data %}
                                        <tr>
                                            <td><strong>{{ row.symbol }}</strong></td>
                                            <td>{{ row.spillover_to|floatformat:2|default:"-" }}</td>
                                            <td>{{ row.spillover_from|floatformat:2|default:"-" }}</td>
                                            <td>
                                                {% if row.net_spillover_positive %}
                                                    <span class="text-success">+{{ row.net_spillover|floatformat:2 }}</span>
                                                {% elif row.net_spillover %}
                                                    <span class="text-danger">{{ row.net_spillover|floatformat:2 }}</span>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted">No spillover analysis results available.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Granger Causality Tab -->
    <div class="tab-pane fade {% if active_tab == 'granger-causality' %}show active{% endif %}" id="granger-causality" role="tabpanel" aria-labelledby="granger-causality-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-arrow-through-heart"></i> Granger Causality Results</h5>
            </div>
            <div class="card-body">
                {% if granger_causality_results.causality_results %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Relationship</th>
                                    <th>Significant at 5%</th>
                                    <th>Significant at 1%</th>
                                    <th>Min P-Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for relationship, test in granger_causality_results.causality_results.items %}
                                    <tr>
                                        <td><strong>{{ relationship }}</strong></td>
                                        <td>
                                            {% if test.significance_summary.significant_at_5pct %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if test.significance_summary.significant_at_1pct %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ test.significance_summary.min_p_value|floatformat:4|default:"-" }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No Granger causality results available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Background Tab -->
    <div class="tab-pane fade {% if active_tab == 'explainer' %}show active{% endif %}" id="explainer" role="tabpanel" aria-labelledby="explainer-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-question-circle"></i> Analysis Background & Context</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info mb-4">
                    <i class="bi bi-info-circle"></i>
                    <strong>Background Context:</strong> This section provides detailed background information and context for the time series analysis, including explanations of the models used and their interpretation.
                </div>

                {% if stationarity_results.all_symbols_stationarity %}
                    <!-- Extract stationarity background context from first symbol -->
                    {% for symbol, test_result in stationarity_results.all_symbols_stationarity.items %}
                        {% if test_result.interpretation.background_context and forloop.first %}
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="bi bi-activity me-2"></i>
                                        Stationarity Testing Background Context
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% for context_key, context_value in test_result.interpretation.background_context.items %}
                                        <div class="mb-3">
                                            <h6 class="text-primary">{{ context_key|title|replace_underscore }}</h6>
                                            {% if context_value is string %}
                                                <p class="mb-0">{{ context_value }}</p>
                                            {% elif context_value.items %}
                                                <ul class="mb-0">
                                                    {% for k, v in context_value.items %}
                                                        <li><strong>{{ k|title|replace_underscore }}:</strong> {{ v }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p class="mb-0">{{ context_value }}</p>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if arima_results %}
                    <!-- Extract background context from first symbol (since it's the same for all) -->
                    {% for symbol, arima in arima_results.items %}
                        {% if arima.interpretation.background_context and forloop.first %}
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="bi bi-graph-up-arrow me-2"></i>
                                        ARIMA Modeling Background Context
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% for context_key, context_value in arima.interpretation.background_context.items %}
                                        <div class="mb-3">
                                            <h6 class="text-primary">{{ context_key|title|replace_underscore }}</h6>
                                            {% if context_value is string %}
                                                <p class="mb-0">{{ context_value }}</p>
                                            {% elif context_value.items %}
                                                <ul class="mb-0">
                                                    {% for k, v in context_value.items %}
                                                        <li><strong>{{ k|title|replace_underscore }}:</strong> {{ v }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p class="mb-0">{{ context_value }}</p>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                {% if garch_results %}
                    <!-- Extract GARCH background context from first symbol -->
                    {% for symbol, garch in garch_results.items %}
                        {% if garch.interpretation.background_context and forloop.first %}
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h6 class="mb-0">
                                        <i class="bi bi-lightning me-2"></i>
                                        GARCH Modeling Background Context
                                    </h6>
                                </div>
                                <div class="card-body">
                                    {% for context_key, context_value in garch.interpretation.background_context.items %}
                                        <div class="mb-3">
                                            <h6 class="text-primary">{{ context_key|title|replace_underscore }}</h6>
                                            {% if context_value is string %}
                                                <p class="mb-0">{{ context_value }}</p>
                                            {% elif context_value.items %}
                                                <ul class="mb-0">
                                                    {% for k, v in context_value.items %}
                                                        <li><strong>{{ k|title|replace_underscore }}:</strong> {{ v }}</li>
                                                    {% endfor %}
                                                </ul>
                                            {% else %}
                                                <p class="mb-0">{{ context_value }}</p>
                                            {% endif %}
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}

                <!-- What is GARCH Section -->
                {% if garch_results %}
                    {% for symbol, garch in garch_results.items %}
                        {% if garch.interpretation.background_context.what_is_garch and forloop.first %}
                            <div class="card mb-4">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0">
                                        <i class="bi bi-lightning-charge me-2"></i>
                                        What is GARCH?
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <p class="mb-0">{{ garch.interpretation.background_context.what_is_garch }}</p>
                                </div>
                            </div>
                        {% endif %}
                    {% endfor %}
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Data Pipeline Tab -->
    <div class="tab-pane fade {% if active_tab == 'data-lineage' %}show active{% endif %}" id="data-lineage-pane" role="tabpanel" aria-labelledby="data-lineage-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-diagram-3"></i> Data Lineage & Transformation Pipeline</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill"></i>
                    <strong>Data Transformation Pipeline:</strong> View the data at each stage of the analysis pipeline. Each tab shows data as it flows through the transformation process from original prices to model-ready formats.
                </div>
                
                <!-- Data Stage Navigation -->
                <ul class="nav nav-pills mb-4" id="dataLineageTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="original-data-tab" data-bs-toggle="pill" data-bs-target="#original-data-stage" 
                                type="button" role="tab" aria-controls="original-data-stage" aria-selected="true">
                            <i class="bi bi-currency-dollar"></i> Original Prices
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="returns-data-tab" data-bs-toggle="pill" data-bs-target="#returns-data-stage" 
                                type="button" role="tab" aria-controls="returns-data-stage" aria-selected="false">
                            <i class="bi bi-graph-up"></i> Returns
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="scaled-data-tab" data-bs-toggle="pill" data-bs-target="#scaled-data-stage" 
                                type="button" role="tab" aria-controls="scaled-data-stage" aria-selected="false">
                            <i class="bi bi-arrows-fullscreen"></i> Scaled for GARCH
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pre-garch-data-tab" data-bs-toggle="pill" data-bs-target="#pre-garch-data-stage" 
                                type="button" role="tab" aria-controls="pre-garch-data-stage" aria-selected="false">
                            <i class="bi bi-box-arrow-in-right"></i> Pre-GARCH
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="post-garch-data-tab" data-bs-toggle="pill" data-bs-target="#post-garch-data-stage" 
                                type="button" role="tab" aria-controls="post-garch-data-stage" aria-selected="false">
                            <i class="bi bi-box-arrow-right"></i> Post-GARCH
                        </button>
                    </li>
                </ul>
                
                <!-- Data Stage Content -->
                <div class="tab-content" id="dataLineageTabsContent">
                    
                    <!-- Original Data Stage -->
                    <div class="tab-pane fade show active" id="original-data-stage" role="tabpanel" aria-labelledby="original-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-currency-dollar"></i> Original Price Data</h6>
                                <p class="text-muted mb-0">Raw financial data as received from the data source</p>
                            </div>
                            <div>
                                <a href="{% url 'timeseries:export_csv' 'original_data' %}" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </a>
                            </div>
                        </div>
                        
                        {% if data_arrays.original_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.original_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> Price Levels</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.original_data.timestamps|slice:":10" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.original_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:4 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.original_data.count > 10 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 10 of {{ data_arrays.original_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No original data available.</p>
                        {% endif %}
                    </div>
                    
                    <!-- Returns Data Stage -->
                    <div class="tab-pane fade" id="returns-data-stage" role="tabpanel" aria-labelledby="returns-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-graph-up"></i> Returns Data</h6>
                                <p class="text-muted mb-0">Logarithmic returns calculated from price data</p>
                            </div>
                            <div>
                                <a href="{% url 'timeseries:export_csv' 'returns_data' %}" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </a>
                            </div>
                        </div>
                        
                        {% if data_arrays.returns_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.returns_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> Log Returns</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.returns_data.timestamps|slice:":10" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.returns_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:6 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.returns_data.count > 10 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 10 of {{ data_arrays.returns_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No returns data available.</p>
                        {% endif %}
                    </div>
                    
                    <!-- Scaled Data Stage -->
                    <div class="tab-pane fade" id="scaled-data-stage" role="tabpanel" aria-labelledby="scaled-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-arrows-fullscreen"></i> Scaled Data for GARCH</h6>
                                <p class="text-muted mb-0">Standardized returns data prepared for GARCH modeling</p>
                            </div>
                            <div>
                                <a href="{% url 'timeseries:export_csv' 'scaled_data' %}" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </a>
                            </div>
                        </div>
                        
                        {% if data_arrays.scaled_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.scaled_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> Standardized Returns</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.scaled_data.timestamps|slice:":10" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.scaled_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:6 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.scaled_data.count > 10 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 10 of {{ data_arrays.scaled_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No scaled data available.</p>
                        {% endif %}
                    </div>
                    
                    <!-- Pre-GARCH Data Stage -->
                    <div class="tab-pane fade" id="pre-garch-data-stage" role="tabpanel" aria-labelledby="pre-garch-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-box-arrow-in-right"></i> Pre-GARCH Data</h6>
                                <p class="text-muted mb-0">Data prepared and ready for GARCH model input</p>
                            </div>
                            <div>
                                <a href="{% url 'timeseries:export_csv' 'pre_garch_data' %}" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </a>
                            </div>
                        </div>
                        
                        {% if data_arrays.pre_garch_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.pre_garch_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> GARCH Input</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.pre_garch_data.timestamps|slice:":10" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.pre_garch_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:6 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.pre_garch_data.count > 10 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 10 of {{ data_arrays.pre_garch_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No pre-GARCH data available.</p>
                        {% endif %}
                    </div>
                    
                    <!-- Post-GARCH Data Stage -->
                    <div class="tab-pane fade" id="post-garch-data-stage" role="tabpanel" aria-labelledby="post-garch-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-box-arrow-right"></i> Post-GARCH Data</h6>
                                <p class="text-muted mb-0">Data after GARCH volatility modeling and residual extraction</p>
                            </div>
                            <div>
                                <a href="{% url 'timeseries:export_csv' 'post_garch_data' %}" 
                                   class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </a>
                            </div>
                        </div>
                        
                        {% if data_arrays.post_garch_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.post_garch_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> GARCH Output</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.post_garch_data.timestamps|slice:":10" %}
                                                                                       <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.post_garch_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:6 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.post_garch_data.count > 10 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 10 of {{ data_arrays.post_garch_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No post-GARCH data available.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}
