<!--
# === FILE META OPENING ===
# file: ./timeseries-frontend/templates/timeseries/results.html
# role: frontend
# desc: main results page template that displays server-side processed analysis results with minimal JavaScript
# === FILE META CLOSING ===
-->

{% extends 'base.html' %}
{% load static %}
{% load dict_extras %}

{% block title %}Lab:Results{% endblock %}

{% block content %}
<div class="d-flex justify-content-between align-items-center mb-4">
    <h1 class="mb-0">Analysis Results</h1>
    <div class="btn-group" role="group">
        <a href="{% url 'timeseries:download_api_response' %}" class="btn btn-outline-primary">
            <i class="bi bi-download"></i> Download API response
        </a>
        <a href="{% url 'timeseries:view_api_response_popup' %}" target="_blank" class="btn btn-outline-secondary">
            <i class="bi bi-eye"></i> View API response
        </a>
    </div>
</div>

{% if no_results %}
<div class="alert alert-warning">
    <h4><i class="bi bi-exclamation-triangle"></i> No Results Found</h4>
    <p>{{ error_message }}</p>
    <a href="{% url 'timeseries:analysis' %}" class="btn btn-primary">Go to Analysis</a>
</div>
{% else %}

<!-- Main Navigation Tabs -->
<ul class="nav nav-tabs mb-4" id="resultsTabs" role="tablist">
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'overview' %}active{% endif %}" id="overview-tab" data-bs-toggle="tab" data-bs-target="#overview" 
                type="button" role="tab" aria-controls="overview" aria-selected="{% if active_tab == 'overview' %}true{% else %}false{% endif %}">
            <i class="bi bi-speedometer2"></i> Overview
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'execution-config' %}active{% endif %}" id="execution-config-tab" data-bs-toggle="tab" data-bs-target="#execution-config" 
                type="button" role="tab" aria-controls="execution-config" aria-selected="{% if active_tab == 'execution-config' %}true{% else %}false{% endif %}">
            <i class="bi bi-gear"></i> Configuration
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'statistical-tests' %}active{% endif %}" id="statistical-tests-tab" data-bs-toggle="tab" data-bs-target="#statistical-tests" 
                type="button" role="tab" aria-controls="statistical-tests" aria-selected="{% if active_tab == 'statistical-tests' %}true{% else %}false{% endif %}">
            <i class="bi bi-graph-up"></i> Statistical Tests
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'arima' %}active{% endif %}" id="arima-tab" data-bs-toggle="tab" data-bs-target="#arima" 
                type="button" role="tab" aria-controls="arima" aria-selected="{% if active_tab == 'arima' %}true{% else %}false{% endif %}">
            <i class="bi bi-graph-up-arrow"></i> ARIMA
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'garch' %}active{% endif %}" id="garch-tab" data-bs-toggle="tab" data-bs-target="#garch" 
                type="button" role="tab" aria-controls="garch" aria-selected="{% if active_tab == 'garch' %}true{% else %}false{% endif %}">
            <i class="bi bi-lightning"></i> GARCH
        </button>
    </li>
    {% if spillover_enabled %}
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'spillover' %}active{% endif %}" id="spillover-tab" data-bs-toggle="tab" data-bs-target="#spillover" 
                type="button" role="tab" aria-controls="spillover" aria-selected="{% if active_tab == 'spillover' %}true{% else %}false{% endif %}">
            <i class="bi bi-arrows-angle-expand"></i> Spillover Analysis
        </button>
    </li>
    {% endif %}
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'granger-causality' %}active{% endif %}" id="granger-causality-tab" data-bs-toggle="tab" data-bs-target="#granger-causality"
                type="button" role="tab" aria-controls="granger-causality" aria-selected="{% if active_tab == 'granger-causality' %}true{% else %}false{% endif %}">
            <i class="bi bi-arrow-through-heart"></i> Granger Causality
        </button>
    </li>
    <li class="nav-item" role="presentation">
        <button class="nav-link {% if active_tab == 'data-lineage' %}active{% endif %}" id="data-lineage-tab" data-bs-toggle="tab" data-bs-target="#data-lineage-pane" 
                type="button" role="tab" aria-controls="data-lineage-pane" aria-selected="{% if active_tab == 'data-lineage' %}true{% else %}false{% endif %}">
            <i class="bi bi-diagram-3"></i> Data Lineage
        </button>
    </li>
</ul>

<div class="tab-content" id="resultsTabsContent">
    
    <!-- Overview Tab -->
    <div class="tab-pane fade {% if active_tab == 'overview' %}show active{% endif %}" id="overview" role="tabpanel" aria-labelledby="overview-tab">
        <div class="row">
            <div class="col-12">
                <!-- Executive Summary Card -->
                <div class="card mb-4">
                    <div class="card-header">
                        <h5 class="card-title mb-0"><i class="bi bi-briefcase"></i> Executive Summary</h5>
                    </div>
                    <div class="card-body">
                        {% if executive_summary.stationarity_summary %}
                            <div class="card mb-3">
                                <div class="card-header bg-primary text-white">
                                    <h6 class="mb-0"><i class="bi bi-activity"></i> Stationarity Analysis Summary</h6>
                                </div>
                                <div class="card-body">
                                    {% for symbol, details in executive_summary.stationarity_summary.items %}
                                        <div class="border-start border-primary border-3 ps-3 mb-3">
                                            <h6 class="text-primary mb-2">{{ symbol|upper }}</h6>
                                            <ul class="mb-0">
                                                {% for key, value in details.items %}
                                                    <li><strong>{{ key|title|replace_underscore }}:</strong> {{ value }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if executive_summary.executive_summary %}
                            <div class="card mb-3">
                                <div class="card-header bg-success text-white">
                                    <h6 class="mb-0"><i class="bi bi-graph-up-arrow"></i> ARIMA Analysis Summary</h6>
                                </div>
                                <div class="card-body">
                                    {% for symbol, details in executive_summary.executive_summary.items %}
                                        <div class="border-start border-success border-3 ps-3 mb-3">
                                            <h6 class="text-success mb-2">{{ symbol|upper }}</h6>
                                            <ul class="mb-0">
                                                {% for key, value in details.items %}
                                                    <li><strong>{{ key|title|replace_underscore }}:</strong> {{ value }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                        
                        {% if executive_summary.garch_summary %}
                            <div class="card mb-3">
                                <div class="card-header bg-warning text-dark">
                                    <h6 class="mb-0"><i class="bi bi-lightning"></i> GARCH Analysis Summary</h6>
                                </div>
                                <div class="card-body">
                                    {% for symbol, details in executive_summary.garch_summary.items %}
                                        <div class="border-start border-warning border-3 ps-3 mb-3">
                                            <h6 class="text-warning mb-2">{{ symbol|upper }}</h6>
                                            <ul class="mb-0">
                                                {% for key, value in details.items %}
                                                    <li><strong>{{ key|title|replace_underscore }}:</strong> {{ value }}</li>
                                                {% endfor %}
                                            </ul>
                                        </div>
                                    {% endfor %}
                                </div>
                            </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Execution Configuration Tab -->
    <div class="tab-pane fade {% if active_tab == 'execution-config' %}show active{% endif %}" id="execution-config" role="tabpanel" aria-labelledby="execution-config-tab">
        <div class="alert alert-info mb-4">
            <i class="bi bi-info-circle"></i>
            <strong>Analysis Configuration:</strong> This section shows all the parameters and settings that were used to execute this analysis.
        </div>
        
        <!-- Data Source Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-database"></i> Data Source Configuration</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.data_source %}
                    <table class="table table-sm">
                        {% for key, value in execution_configuration.data_source.items %}
                        <tr>
                            <td><strong>{{ key|title }}:</strong></td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">No data source configuration available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Model Configurations -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-cpu"></i> Model Configurations</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.model_configurations %}
                    <div class="row">
                        <div class="col-md-6">
                            <h6><i class="bi bi-graph-up-arrow"></i> ARIMA Parameters</h6>
                            {% if execution_configuration.model_configurations.arima_params %}
                                <table class="table table-sm">
                                    {% for key, value in execution_configuration.model_configurations.arima_params.items %}
                                    <tr>
                                        <td><strong>{{ key }}:</strong></td>
                                        <td>{{ value }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            {% endif %}
                        </div>
                        <div class="col-md-6">
                            <h6><i class="bi bi-lightning"></i> GARCH Parameters</h6>
                            {% if execution_configuration.model_configurations.garch_params %}
                                <table class="table table-sm">
                                    {% for key, value in execution_configuration.model_configurations.garch_params.items %}
                                    <tr>
                                        <td><strong>{{ key }}:</strong></td>
                                        <td>{{ value }}</td>
                                    </tr>
                                    {% endfor %}
                                </table>
                            {% endif %}
                        </div>
                    </div>
                {% endif %}
            </div>
        </div>
        
        <!-- Data Processing Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-sliders"></i> Data Processing Configuration</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.data_processing %}
                    <table class="table table-sm">
                        {% for key, value in execution_configuration.data_processing.items %}
                        <tr>
                            <td><strong>{{ key|title|replace_underscore }}:</strong></td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">No data processing configuration available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Spillover Configuration -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-shuffle"></i> Spillover Configuration</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.spillover_configuration %}
                    <table class="table table-sm">
                        {% for key, value in execution_configuration.spillover_configuration.items %}
                        <tr>
                            <td><strong>{{ key|title|replace_underscore }}:</strong></td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">No spillover configuration available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Execution Metadata -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-clock-history"></i> Execution Metadata</h5>
            </div>
            <div class="card-body">
                {% if execution_configuration.execution_metadata %}
                    <table class="table table-sm">
                        {% for key, value in execution_configuration.execution_metadata.items %}
                        <tr>
                            <td><strong>{{ key|title|replace_underscore }}:</strong></td>
                            <td>{{ value }}</td>
                        </tr>
                        {% endfor %}
                    </table>
                {% else %}
                    <p class="text-muted">No execution metadata available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Statistical Tests Tab -->
    <div class="tab-pane fade {% if active_tab == 'statistical-tests' %}show active{% endif %}" id="statistical-tests" role="tabpanel" aria-labelledby="statistical-tests-tab">
        <!-- Stationarity Tests -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-activity me-2"></i> Stationarity Tests (ADF)</h5>
            </div>
            <div class="card-body">
                {% if stationarity_results.all_symbols_stationarity %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Status</th>
                                    <th>Test Statistic</th>
                                    <th>P-Value</th>
                                    <th>Critical Values (1%, 5%, 10%)</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for symbol, test in stationarity_results.all_symbols_stationarity.items %}
                                    <tr>
                                        <td><strong>{{ symbol }}</strong></td>
                                        <td>
                                            {% if test.is_stationary %}
                                                <span class="badge bg-success">Stationary</span>
                                            {% else %}
                                                <span class="badge bg-warning">Non-Stationary</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ test.adf_statistic|floatformat:4 }}</td>
                                        <td>{{ test.p_value|floatformat:4 }}</td>
                                        <td>
                                            {% if test.critical_values %}
                                                {% for key, value in test.critical_values.items %}
                                                    {{ value|floatformat:3 }}{% if not forloop.last %}, {% endif %}
                                                {% endfor %}
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No stationarity test results available.</p>
                {% endif %}
            </div>
        </div>
        
        <!-- Series Statistics -->
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-bar-chart me-2"></i> Series Statistics</h5>
            </div>
            <div class="card-body">
                {% if stationarity_results.series_stats %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Symbol</th>
                                    <th>Count</th>
                                    <th>Mean</th>
                                    <th>Std Dev</th>
                                    <th>Min</th>
                                    <th>Max</th>
                                    <th>Skewness</th>
                                    <th>Kurtosis</th>
                                    <th>Ann. Vol</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for symbol, stats in stationarity_results.series_stats.items %}
                                <tr>
                                    <td><strong>{{ symbol }}</strong></td>
                                    <td>{{ stats.n|default:"-" }}</td>
                                    <td>{{ stats.mean|floatformat:6|default:"-" }}</td>
                                    <td>{{ stats.std|floatformat:6|default:"-" }}</td>
                                    <td>{{ stats.min|floatformat:6|default:"-" }}</td>
                                    <td>{{ stats.max|floatformat:6|default:"-" }}</td>
                                    <td>{{ stats.skew|floatformat:3|default:"-" }}</td>
                                    <td>{{ stats.kurt|floatformat:3|default:"-" }}</td>
                                    <td>{{ stats.annualized_vol|floatformat:4|default:"-" }}</td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No series statistics available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- ARIMA Tab -->
    <div class="tab-pane fade {% if active_tab == 'arima' %}show active{% endif %}" id="arima" role="tabpanel" aria-labelledby="arima-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-graph-up-arrow"></i> ARIMA Model Results</h5>
            </div>
            <div class="card-body">
                {% if arima_results %}
                    {% for symbol, arima in arima_results.items %}
                        <div class="border rounded p-3 mb-3">
                            <h6><strong>{{ symbol }}</strong></h6>
                            
                            {% if arima.interpretation.executive_summary %}
                                <div class="alert alert-info">
                                    <strong>Executive Summary:</strong> {{ arima.interpretation.executive_summary.bottom_line }}
                                </div>
                            {% endif %}
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Model Summary</h6>
                                    {% if arima.summary %}
                                        <table class="table table-sm">
                                            <tr><td><strong>Model:</strong></td><td>{{ arima.summary.model_specification|default:"-" }}</td></tr>
                                            <tr><td><strong>AIC:</strong></td><td>{{ arima.summary.aic|floatformat:2|default:"-" }}</td></tr>
                                            <tr><td><strong>BIC:</strong></td><td>{{ arima.summary.bic|floatformat:2|default:"-" }}</td></tr>
                                            <tr><td><strong>HQIC:</strong></td><td>{{ arima.summary.hqic|floatformat:2|default:"-" }}</td></tr>
                                            <tr><td><strong>Log Likelihood:</strong></td><td>{{ arima.summary.log_likelihood|floatformat:2|default:"-" }}</td></tr>
                                            <tr><td><strong>Sample Size:</strong></td><td>{{ arima.summary.sample_size|default:"-" }}</td></tr>
                                        </table>
                                        <h6 class="mt-3">Parameters</h6>
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Parameter</th>
                                                    <th>Value</th>
                                                    <th>P-Value</th>
                                                    <th>Significance</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for param in param_list %}
                                                    <tr>
                                                        <td>{{ param }}</td>
                                                        <td>{{ arima.summary.parameters|lookup:param|floatformat:4|default:"-" }}</td>
                                                        <td>{{ arima.summary.parameter_pvalues|lookup:param|floatformat:4|default:"-" }}</td>
                                                        <td>{{ arima.summary.parameter_significance|lookup:param|default:"-" }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                        {% if arima.summary.residual_statistics %}
                                        <h6 class="mt-3">Residual Statistics</h6>
                                        <table class="table table-bordered table-sm">
                                            <thead>
                                                <tr>
                                                    <th>Statistic</th>
                                                    <th>Value</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                {% for stat, value in arima.summary.residual_statistics.items %}
                                                    <tr>
                                                        <td>{{ stat|title|replace_underscore }}</td>
                                                        <td>{{ value|floatformat:4|default:"-" }}</td>
                                                    </tr>
                                                {% endfor %}
                                            </tbody>
                                        </table>
                                    {% endif %}
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6>Forecast Summary</h6>
                                    {% if arima.forecast %}
                                        <table class="table table-sm">
                                            <tr><td><strong>Forecast Steps:</strong></td><td>{{ arima.forecast.forecast_steps|default:"-" }}</td></tr>
                                            <tr><td><strong>Method:</strong></td><td>{{ arima.forecast.forecast_method|default:"-" }}</td></tr>
                                            {% if arima.forecast.point_forecasts %}
                                                <tr><td><strong>Next Value:</strong></td><td>{{ arima.forecast.point_forecasts.0|floatformat:4 }}</td></tr>
                                            {% endif %}
                                        </table>
                                    {% endif %}
                                </div>
                            </div>
                            
                            {% if arima.interpretation.key_findings %}
                                <div class="mt-2">
                                    <h6>Key Findings</h6>
                                    {% for finding_type, finding_text in arima.interpretation.key_findings.items %}
                                        {% if finding_text %}
                                            <div class="mb-2">
                                                <strong>{{ finding_type|title|replace_underscore }}:</strong>
                                                {% if finding_text is string %}
                                                    <span>{{ finding_text }}</span>
                                                {% elif finding_text.items %}
                                                    <ul class="mb-0">
                                                        {% for k, v in finding_text.items %}
                                                            <li><strong>{{ k|title|replace_underscore }}:</strong> {{ v }}</li>
                                                        {% endfor %}
                                                    </ul>
                                                {% else %}
                                                    <span>{{ finding_text }}</span>
                                                {% endif %}
                                            </div>
                                        {% endif %}
                                    {% endfor %}
                                </div>
                            {% endif %}
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No ARIMA results available.</p>
                {% endif %}
            </div>
        </div>
        
    </div>

    <!-- GARCH Tab -->
    <div class="tab-pane fade {% if active_tab == 'garch' %}show active{% endif %}" id="garch" role="tabpanel" aria-labelledby="garch-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-lightning"></i> GARCH Model Results</h5>
            </div>
            <div class="card-body">
                {% if garch_results %}
                    {% for symbol, garch in garch_results.items %}
                        <div class="border rounded p-3 mb-3">
                            <h6><strong>{{ symbol }}</strong></h6>
                            
                            {% if garch.interpretation.executive_summary %}
                                <div class="alert alert-warning">
                                    <strong>Volatility Summary:</strong> {{ garch.interpretation.executive_summary.bottom_line }}
                                </div>
                            {% endif %}
                            
                            <div class="row">
                                <div class="col-md-6">
                                    <h6>Model Parameters</h6>
                                    {% if garch.summary %}
                                        <p><small>{{ garch.summary|truncatechars:200 }}</small></p>
                                    {% endif %}
                                </div>
                                <div class="col-md-6">
                                    <h6>Volatility Forecast</h6>
                                    {% if garch.forecast %}
                                        <p>{{ garch.forecast|length }} forecast periods</p>
                                        {% if garch.forecast.0 %}
                                            <p><strong>Next Period Volatility:</strong> {{ garch.forecast.0|floatformat:6 }}</p>
                                        {% endif %}
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                    {% endfor %}
                {% else %}
                    <p class="text-muted">No GARCH results available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Spillover Analysis Tab -->
    {% if spillover_enabled %}
    <div class="tab-pane fade {% if active_tab == 'spillover' %}show active{% endif %}" id="spillover" role="tabpanel" aria-labelledby="spillover-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-arrows-angle-expand"></i> Spillover Analysis Results</h5>
            </div>
            <div class="card-body">
                {% if spillover_results %}
                    {% if spillover_results.total_spillover_index %}
                        <div class="alert alert-primary">
                            <h6><strong>Total Spillover Index:</strong> {{ spillover_results.total_spillover_index|floatformat:2 }}%</h6>
                            <p>This indicates the percentage of forecast error variance that comes from spillovers between assets.</p>
                        </div>
                    {% endif %}
                    
                    {% if spillover_results.interpretation %}
                        <div class="alert alert-info">
                            <strong>Interpretation:</strong> {{ spillover_results.interpretation }}
                        </div>
                    {% endif %}
                    
                    {% if spillover_results.spillover_table_data %}
                        <h6>Directional Spillover</h6>
                        <div class="table-responsive">
                            <table class="table table-striped">
                                <thead>
                                    <tr>
                                        <th>Asset</th>
                                        <th>Spillover TO Others (%)</th>
                                        <th>Spillover FROM Others (%)</th>
                                        <th>Net Spillover (%)</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for row in spillover_results.spillover_table_data %}
                                        <tr>
                                            <td><strong>{{ row.symbol }}</strong></td>
                                            <td>{{ row.spillover_to|floatformat:2|default:"-" }}</td>
                                            <td>{{ row.spillover_from|floatformat:2|default:"-" }}</td>
                                            <td>
                                                {% if row.net_spillover_positive %}
                                                    <span class="text-success">+{{ row.net_spillover|floatformat:2 }}</span>
                                                {% elif row.net_spillover %}
                                                    <span class="text-danger">{{ row.net_spillover|floatformat:2 }}</span>
                                                {% else %}
                                                    -
                                                {% endif %}
                                            </td>
                                        </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    {% endif %}
                {% else %}
                    <p class="text-muted">No spillover analysis results available.</p>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    <!-- Granger Causality Tab -->
    <div class="tab-pane fade {% if active_tab == 'granger-causality' %}show active{% endif %}" id="granger-causality" role="tabpanel" aria-labelledby="granger-causality-tab">
        <div class="card mb-4">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-arrow-through-heart"></i> Granger Causality Results</h5>
            </div>
            <div class="card-body">
                {% if granger_causality_results.causality_results %}
                    <div class="table-responsive">
                        <table class="table table-striped">
                            <thead>
                                <tr>
                                    <th>Relationship</th>
                                    <th>Significant at 5%</th>
                                    <th>Significant at 1%</th>
                                    <th>Min P-Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for relationship, test in granger_causality_results.causality_results.items %}
                                    <tr>
                                        <td><strong>{{ relationship }}</strong></td>
                                        <td>
                                            {% if test.significance_summary.significant_at_5pct %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </td>
                                        <td>
                                            {% if test.significance_summary.significant_at_1pct %}
                                                <span class="badge bg-success">Yes</span>
                                            {% else %}
                                                <span class="badge bg-secondary">No</span>
                                            {% endif %}
                                        </td>
                                        <td>{{ test.significance_summary.min_p_value|floatformat:4|default:"-" }}</td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-muted">No Granger causality results available.</p>
                {% endif %}
            </div>
        </div>
    </div>

    <!-- Data Lineage Tab -->
    <div class="tab-pane fade {% if active_tab == 'data-lineage' %}show active{% endif %}" id="data-lineage-pane" role="tabpanel" aria-labelledby="data-lineage-tab">
        <div class="card">
            <div class="card-header">
                <h5 class="card-title mb-0"><i class="bi bi-diagram-3"></i> Data Lineage & Transformation Pipeline</h5>
            </div>
            <div class="card-body">
                <div class="alert alert-info">
                    <i class="bi bi-info-circle-fill"></i>
                    <strong>Data Transformation Pipeline:</strong> View the data at each stage of the analysis pipeline. Each tab shows data as it flows through the transformation process from original prices to model-ready formats.
                </div>
                
                <!-- Data Stage Navigation -->
                <ul class="nav nav-pills mb-4" id="dataLineageTabs" role="tablist">
                    <li class="nav-item" role="presentation">
                        <button class="nav-link active" id="original-data-tab" data-bs-toggle="pill" data-bs-target="#original-data-stage" 
                                type="button" role="tab" aria-controls="original-data-stage" aria-selected="true">
                            <i class="bi bi-currency-dollar"></i> Original Prices
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="returns-data-tab" data-bs-toggle="pill" data-bs-target="#returns-data-stage" 
                                type="button" role="tab" aria-controls="returns-data-stage" aria-selected="false">
                            <i class="bi bi-graph-up"></i> Returns
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="scaled-data-tab" data-bs-toggle="pill" data-bs-target="#scaled-data-stage" 
                                type="button" role="tab" aria-controls="scaled-data-stage" aria-selected="false">
                            <i class="bi bi-arrows-fullscreen"></i> Scaled for GARCH
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="pre-garch-data-tab" data-bs-toggle="pill" data-bs-target="#pre-garch-data-stage" 
                                type="button" role="tab" aria-controls="pre-garch-data-stage" aria-selected="false">
                            <i class="bi bi-box-arrow-in-right"></i> Pre-GARCH
                        </button>
                    </li>
                    <li class="nav-item" role="presentation">
                        <button class="nav-link" id="post-garch-data-tab" data-bs-toggle="pill" data-bs-target="#post-garch-data-stage" 
                                type="button" role="tab" aria-controls="post-garch-data-stage" aria-selected="false">
                            <i class="bi bi-box-arrow-right"></i> Post-GARCH
                        </button>
                    </li>
                </ul>
                
                <!-- Data Stage Content -->
                <div class="tab-content" id="dataLineageTabsContent">
                    
                    <!-- Original Data Stage -->
                    <div class="tab-pane fade show active" id="original-data-stage" role="tabpanel" aria-labelledby="original-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-currency-dollar"></i> Original Price Data</h6>
                                <p class="text-muted mb-0">Raw financial data as received from the data source</p>
                            </div>
                            <form method="post" action="{% url 'timeseries:export_csv' 'original_data' %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </form>
                        </div>
                        
                        {% if data_arrays.original_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.original_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> Price Levels</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.original_data.timestamps|slice:":50" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.original_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:4 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.original_data.count > 50 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 50 of {{ data_arrays.original_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No original data available.</p>
                        {% endif %}
                    </div>
                    
                    <!-- Returns Data Stage -->
                    <div class="tab-pane fade" id="returns-data-stage" role="tabpanel" aria-labelledby="returns-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-graph-up"></i> Returns Data</h6>
                                <p class="text-muted mb-0">Logarithmic returns calculated from price data</p>
                            </div>
                            <form method="post" action="{% url 'timeseries:export_csv' 'returns_data' %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </form>
                        </div>
                        
                        {% if data_arrays.returns_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.returns_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> Log Returns</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.returns_data.timestamps|slice:":50" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.returns_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:6 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.returns_data.count > 50 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 50 of {{ data_arrays.returns_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No returns data available.</p>
                        {% endif %}
                    </div>
                    
                    <!-- Scaled Data Stage -->
                    <div class="tab-pane fade" id="scaled-data-stage" role="tabpanel" aria-labelledby="scaled-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-arrows-fullscreen"></i> Scaled Data for GARCH</h6>
                                <p class="text-muted mb-0">Standardized returns data prepared for GARCH modeling</p>
                            </div>
                            <form method="post" action="{% url 'timeseries:export_csv' 'scaled_data' %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </form>
                        </div>
                        
                        {% if data_arrays.scaled_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.scaled_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> Standardized Returns</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.scaled_data.timestamps|slice:":50" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.scaled_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:6 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.scaled_data.count > 50 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 50 of {{ data_arrays.scaled_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No scaled data available.</p>
                        {% endif %}
                    </div>
                    
                    <!-- Pre-GARCH Data Stage -->
                    <div class="tab-pane fade" id="pre-garch-data-stage" role="tabpanel" aria-labelledby="pre-garch-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-box-arrow-in-right"></i> Pre-GARCH Data</h6>
                                <p class="text-muted mb-0">Data prepared and ready for GARCH model input</p>
                            </div>
                            <form method="post" action="{% url 'timeseries:export_csv' 'pre_garch_data' %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </form>
                        </div>
                        
                        {% if data_arrays.pre_garch_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.pre_garch_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> GARCH Input</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.pre_garch_data.timestamps|slice:":50" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.pre_garch_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:6 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.pre_garch_data.count > 50 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 50 of {{ data_arrays.pre_garch_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No pre-GARCH data available.</p>
                        {% endif %}
                    </div>
                    
                    <!-- Post-GARCH Data Stage -->
                    <div class="tab-pane fade" id="post-garch-data-stage" role="tabpanel" aria-labelledby="post-garch-data-tab">
                        <div class="d-flex justify-content-between align-items-center mb-3">
                            <div>
                                <h6><i class="bi bi-box-arrow-right"></i> Post-GARCH Data</h6>
                                <p class="text-muted mb-0">Data after GARCH volatility modeling and residual extraction</p>
                            </div>
                            <form method="post" action="{% url 'timeseries:export_csv' 'post_garch_data' %}" style="display: inline;">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-success btn-sm">
                                    <i class="bi bi-download"></i> Export CSV
                                </button>
                            </form>
                        </div>
                        
                        {% if data_arrays.post_garch_data %}
                            <div class="row mb-3">
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Records:</strong> {{ data_arrays.post_garch_data.count }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Symbols:</strong> {{ symbols|join:", " }}</small>
                                    </div>
                                </div>
                                <div class="col-md-4">
                                    <div class="bg-light p-2 rounded">
                                        <small><strong>Type:</strong> GARCH Output</small>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="table-responsive" style="max-height: 400px; overflow-y: auto;">
                                <table class="table table-striped table-sm">
                                    <thead class="table-dark sticky-top">
                                        <tr>
                                            <th>Date</th>
                                            {% for symbol in symbols %}
                                                <th>{{ symbol }}</th>
                                            {% endfor %}
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for timestamp in data_arrays.post_garch_data.timestamps|slice:":50" %}
                                            <tr>
                                                <td>{{ timestamp }}</td>
                                                {% for symbol in symbols %}
                                                    <td>{{ data_arrays.post_garch_data.symbol_data|lookup:symbol|index:forloop.parentloop.counter0|floatformat:6 }}</td>
                                                {% endfor %}
                                            </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            {% if data_arrays.post_garch_data.count > 50 %}
                                <div class="text-muted text-center mt-2">
                                    <small>Showing first 50 of {{ data_arrays.post_garch_data.count }} records. Export to CSV for full dataset.</small>
                                </div>
                            {% endif %}
                        {% else %}
                            <p class="text-muted">No post-GARCH data available.</p>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endif %}
{% endblock %}
