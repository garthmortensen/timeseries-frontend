<!--
# === FILE META OPENING ===
# file: ./timeseries-frontend/templates/timeseries/analysis.html
# role: frontend
# desc: analysis configuration form template with ARIMA, GARCH, and spillover parameter inputs with improved UX
# === FILE META CLOSING ===
-->

{% extends 'base.html' %}
{% load static %}

{% block title %}Analysis - Spillover Lab{% endblock %}

{% block extra_css %}
<style>
    .form-section {
        margin-bottom: 2rem;
        padding: 1.5rem;
        background-color: #f8f9fa;
        border-radius: 0.5rem;
        border: 1px solid #e9ecef;
    }
    
    .section-header {
        margin-bottom: 1.5rem;
        padding-bottom: 0.5rem;
        border-bottom: 2px solid #dee2e6;
        color: #495057;
    }
    
    .guide-text {
        border-left: 4px solid #2196f3;
        padding: 0.75rem 1rem;
        margin-bottom: 1rem;
        border-radius: 0 0.25rem 0.25rem 0;
        font-style: italic;
        color: #1565c0;
        font-size: 0.95em;
        line-height: 1.4;
        background-color: #e3f2fd;
    }
    
    .parameter-help {
        padding: 0.75rem 1rem;
        margin-top: 0.5rem;
        border-radius: 0.375rem;
        font-size: 0.875em;
        color: #495057;
        background-color: #fff3cd;
        border: 1px solid #ffeaa7;
        border-left: 4px solid #f39c12;
        display: none; /* Hidden by default */
        animation: slideDown 0.3s ease-out;
    }
    
    @keyframes slideDown {
        from {
            opacity: 0;
            max-height: 0;
            padding-top: 0;
            padding-bottom: 0;
        }
        to {
            opacity: 1;
            max-height: 200px;
            padding-top: 0.75rem;
            padding-bottom: 0.75rem;
        }
    }
    
    .parameter-help.show {
        display: block;
    }
    
    .parameter-help strong {
        color: #2c3e50;
        display: block;
        margin-bottom: 0.5rem;
    }
    
    .help-toggle {
        color: #6c757d;
        cursor: pointer;
        font-size: 0.8em;
        text-decoration: none;
        margin-left: 0.5rem;
        padding: 0.125rem 0.375rem;
        border-radius: 0.25rem;
        background-color: #f8f9fa;
        border: 1px solid #dee2e6;
        transition: all 0.2s ease;
    }
    
    .help-toggle:hover {
        color: #495057;
        background-color: #e9ecef;
        text-decoration: none;
    }
    
    .help-toggle.expanded {
        background-color: #fff3cd;
        border-color: #f39c12;
        color: #856404;
    }
    
    .help-toggle.collapsed::after {
        content: " ?";
        font-weight: bold;
    }
    
    .help-toggle.expanded::after {
        content: " ‚ñº";
    }
    
    /* Improved form styling */
    .form-label {
        font-weight: 600;
        margin-bottom: 0.5rem;
        color: #495057;
    }
    
    .form-control:focus, .form-select:focus {
        border-color: #2196f3;
        box-shadow: 0 0 0 0.2rem rgba(33, 150, 243, 0.25);
    }
    
    /* Preset buttons */
    .preset-buttons {
        display: flex;
        gap: 0.5rem;
        flex-wrap: wrap;
        margin-bottom: 1rem;
    }
    
    .preset-btn {
        padding: 0.375rem 0.75rem;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        background-color: #f8f9fa;
        color: #495057;
        cursor: pointer;
        transition: all 0.2s ease;
        font-size: 0.875em;
    }
    
    .preset-btn:hover {
        background-color: #e9ecef;
        border-color: #adb5bd;
    }
    
    .preset-btn.active {
        background-color: #2196f3;
        border-color: #2196f3;
        color: white;
    }
    
    /* Progress indicator */
    .section-progress {
        width: 100%;
        height: 4px;
        background-color: #e9ecef;
        border-radius: 2px;
        margin-bottom: 1rem;
    }
    
    .section-progress-bar {
        height: 100%;
        background-color: #28a745;
        border-radius: 2px;
        width: 0%;
        transition: width 0.3s ease;
    }
</style>
{% endblock %}

{% block content %}
<h1 class="mb-4">Time Series Analysis Configuration</h1>

<!-- Progress Indicator -->
<div class="section-progress">
    <div class="section-progress-bar" id="progress-bar"></div>
</div>

<div class="d-flex justify-content-between align-items-center mb-3">
    <div class="preset-buttons">
        <button class="preset-btn" data-preset="conservative">üìä Conservative</button>
        <button class="preset-btn" data-preset="balanced">‚öñÔ∏è Balanced</button>
        <button class="preset-btn" data-preset="aggressive">üöÄ High Volatility</button>
        <button class="preset-btn" data-preset="crypto">‚Çø Crypto Markets</button>
    </div>
    
    <div class="d-flex gap-2">
        <a href="{{ TIMESERIES_API_URL }}/docs" class="btn btn-outline-secondary btn-sm" target="_blank">üìñ API Docs</a>
        <a href="{{ TIMESERIES_API_URL }}/v1/graphql" class="btn btn-outline-secondary btn-sm" target="_blank">üîç GraphQL</a>
    </div>
</div>

<form id="analysis-form" method="post" action="{% url 'timeseries:run_pipeline' %}">
    {% csrf_token %}
        
    <div class="form-section" data-section="data-source">
        <h3 class="section-header">üìä Data Source</h3>
        <div class="guide-text">
            Choose between synthetic test data or real market data for your analysis.
        </div>
        
        <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="source_actual_or_synthetic_data" id="data-source-synthetic" value="synthetic" checked>
            <label class="form-check-label" for="data-source-synthetic">
                <strong>üé≤ Synthetic Data</strong><br>
                <small class="text-muted">Generate artificial time series data for testing and learning</small>
            </label>
        </div>
        <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="source_actual_or_synthetic_data" id="data-source-actual-yfinance" value="actual_yfinance">
            <label class="form-check-label" for="data-source-actual-yfinance">
                <strong>üìà Yahoo Finance</strong><br>
                <small class="text-muted">Real market data (rate limited)</small>
            </label>
        </div>
        <div class="form-check mb-3">
            <input class="form-check-input" type="radio" name="source_actual_or_synthetic_data" id="data-source-actual-stooq" value="actual_stooq">
            <label class="form-check-label" for="data-source-actual-stooq">
                <strong>üåç Stooq</strong><br>
                <small class="text-muted">Global market data provider</small>
            </label>
        </div>
    </div>

    <div class="form-section" data-section="symbols">
        <h3 class="section-header">üéØ Asset Selection</h3>
        <div class="guide-text">
            Select the financial instruments you want to analyze.
        </div>
        
        <div class="mb-4">
            <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="symbol_selection_method" id="symbol-method-manual" value="manual" checked>
                <label class="form-check-label" for="symbol-method-manual">
                    <strong>‚úèÔ∏è Manual Entry</strong> - Type specific symbols
                </label>
            </div>
            <div class="form-check mb-3">
                <input class="form-check-input" type="radio" name="symbol_selection_method" id="symbol-method-predefined" value="predefined">
                <label class="form-check-label" for="symbol-method-predefined">
                    <strong>üìã Browse Categories</strong> - Choose from organized lists
                </label>
            </div>
        </div>

        <!-- Manual Symbol Entry -->
        <div id="manual-symbol-entry">
            <div id="market-params" style="display: none;">
                <div class="mb-3">
                    <label for="symbols" class="form-label">Market Symbols</label>
                    <input type="text" class="form-control" id="symbols" name="symbols" value="^DJI,^HSI,^FCHI" placeholder="e.g., AAPL,MSFT,GOOGL">
                </div>
            </div>
            
            <div id="synthetic-params">
                <div class="mb-3">
                    <label for="synthetic-symbols" class="form-label">Symbol Names</label>
                    <input type="text" class="form-control" id="synthetic-symbols" name="synthetic_symbols" value="^DJI,^HSI,^FCHI" placeholder="e.g., SYM1,SYM2,SYM3">
                </div>
                <div class="mb-3">
                    <label for="synthetic-anchor-prices" class="form-label">Starting Prices</label>
                    <input type="text" class="form-control" id="synthetic-anchor-prices" name="synthetic_anchor_prices" value="150.0,200.0,15.0" placeholder="e.g., 100.0,200.0,50.0">
                </div>
            </div>
        </div>

        <!-- Predefined Lists (simplified for this example) -->
        <div id="predefined-symbol-selection" style="display: none;">
            <p class="text-muted">Category selection interface would go here...</p>
        </div>
    </div>
    
    <div class="form-section" data-section="dates">
        <h3 class="section-header">üìÖ Time Period</h3>
        <div class="guide-text">
            Define the date range for your analysis.
        </div>
        
        <div class="row">
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="data-start-date" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="data-start-date" name="data_start_date" value="2023-01-01">
                </div>
            </div>
            <div class="col-md-6">
                <div class="mb-3">
                    <label for="data-end-date" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="data-end-date" name="data_end_date" value="2023-02-01">
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-section" data-section="preprocessing">
        <h3 class="section-header">üîß Data Preprocessing</h3>
        <div class="guide-text">
            Normalize data to ensure fair comparison between different assets.
        </div>
        
        <div class="mb-3">
            <label for="scaling-method" class="form-label">
                Scaling Method
                <a href="#" class="help-toggle collapsed" data-target="scaling-help">Help</a>
            </label>
            <select class="form-select" id="scaling-method" name="scaling_method">
                <option value="standardize" selected>Standardize (Z-score)</option>
                <option value="minmax">Min-Max Scaling</option>
                <option value="none">No Scaling</option>
            </select>
            <div class="parameter-help" id="scaling-help">
                <strong>Choose based on your analysis needs:</strong><br>
                ‚Ä¢ <strong>Standardize:</strong> Best for most analyses - centers data around zero while preserving relationships<br>
                ‚Ä¢ <strong>Min-Max:</strong> Scales to 0-1 range - good when you need bounded values<br>
                ‚Ä¢ <strong>No Scaling:</strong> Keep original prices - only for similar-priced assets
            </div>
        </div>
    </div>
    
    <div class="form-section" data-section="arima">
        <h3 class="section-header">üìà ARIMA Parameters</h3>
        <div class="guide-text">
            Configure the ARIMA model for price prediction and trend analysis.
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="arima-p" class="form-label">
                        p: Auto-Regressive
                        <a href="#" class="help-toggle collapsed" data-target="arima-p-help">Help</a>
                    </label>
                    <input type="number" class="form-control" id="arima-p" name="arima_p" min="0" max="10" value="2">
                    <div class="parameter-help" id="arima-p-help">
                        <strong>How much does today depend on yesterday?</strong><br>
                        Higher values (3-5) capture longer-term momentum but may overfit. Start with 1-2 for most financial series.
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="arima-d" class="form-label">
                        d: Differencing
                        <a href="#" class="help-toggle collapsed" data-target="arima-d-help">Help</a>
                    </label>
                    <input type="number" class="form-control" id="arima-d" name="arima_d" min="0" max="2" value="0">
                    <div class="parameter-help" id="arima-d-help">
                        <strong>How many times to difference the data</strong><br>
                        Usually 0 since this pipeline converts prices to returns automatically. Use 1 only for very trending data.
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="arima-q" class="form-label">
                        q: Moving Average
                        <a href="#" class="help-toggle collapsed" data-target="arima-q-help">Help</a>
                    </label>
                    <input type="number" class="form-control" id="arima-q" name="arima_q" min="0" max="10" value="4">
                    <div class="parameter-help" id="arima-q-help">
                        <strong>How much do surprises affect future prices?</strong><br>
                        Higher values (3-6) help capture market overreactions and corrections in financial data.
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <div class="form-section" data-section="garch">
        <h3 class="section-header">üìä GARCH Parameters</h3>
        <div class="guide-text">
            Configure volatility modeling to understand risk patterns and market stress.
        </div>
        
        <div class="row">
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="garch-p" class="form-label">
                        p: ARCH Effect
                        <a href="#" class="help-toggle collapsed" data-target="garch-p-help">Help</a>
                    </label>
                    <input type="number" class="form-control" id="garch-p" name="garch_p" min="0" max="5" value="1">
                    <div class="parameter-help" id="garch-p-help">
                        <strong>How recent volatility affects today</strong><br>
                        1 is usually enough. Use 2-3 for extremely volatile assets like crypto or emerging markets.
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="garch-q" class="form-label">
                        q: Persistence
                        <a href="#" class="help-toggle collapsed" data-target="garch-q-help">Help</a>
                    </label>
                    <input type="number" class="form-control" id="garch-q" name="garch_q" min="0" max="5" value="1">
                    <div class="parameter-help" id="garch-q-help">
                        <strong>How long volatility clusters persist</strong><br>
                        1 handles most cases. Use 2 for assets with very persistent volatility like VIX or commodities.
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="mb-3">
                    <label for="garch-dist" class="form-label">
                        Distribution
                        <a href="#" class="help-toggle collapsed" data-target="garch-dist-help">Help</a>
                    </label>
                    <select class="form-select" id="garch-dist" name="garch_dist">
                        <option value="normal">Normal</option>
                        <option value="t" selected>Student's t</option>
                        <option value="skewt">Skewed t</option>
                    </select>
                    <div class="parameter-help" id="garch-dist-help">
                        <strong>Student's t (recommended) handles market crashes better</strong><br>
                        Financial markets have "fat tails" - extreme moves happen more than normal distribution predicts.
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="form-section" data-section="spillover">
        <h3 class="section-header">üåä Spillover Analysis</h3>
        <div class="guide-text">
            Measure how shocks spread between markets - crucial for portfolio risk management.
        </div>
        
        <div class="form-check form-switch mb-3">
            <input class="form-check-input" type="checkbox" id="enable-spillover" name="enable_spillover" checked>
            <label class="form-check-label" for="enable-spillover">
                <strong>Enable Spillover Analysis</strong>
                <a href="#" class="help-toggle collapsed" data-target="spillover-enable-help">Help</a>
            </label>
            <div class="parameter-help" id="spillover-enable-help">
                <strong>Essential for multi-asset portfolios</strong><br>
                Reveals how much each asset's volatility comes from other assets vs its own shocks. Disable only for single-asset analysis.
            </div>
        </div>
        
        <div id="spillover-params">
            <div class="row">
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="forecast-horizon" class="form-label">
                            Forecast Horizon
                            <a href="#" class="help-toggle collapsed" data-target="horizon-help">Help</a>
                        </label>
                        <input type="number" class="form-control" id="forecast-horizon" name="forecast_horizon" min="1" max="10" value="3">
                        <div class="parameter-help" id="horizon-help">
                            <strong>How far ahead to measure spillovers</strong><br>
                            Short (1-3): immediate contagion ‚Ä¢ Long (5-10): persistent connections
                        </div>
                    </div>
                </div>
                <div class="col-md-6">
                    <div class="mb-3">
                        <label for="spillover-method" class="form-label">
                            Method
                            <a href="#" class="help-toggle collapsed" data-target="method-help">Help</a>
                        </label>
                        <select class="form-select" id="spillover-method" name="spillover_method">
                            <option value="diebold_yilmaz" selected>Diebold-Yilmaz (Fast)</option>
                            <option value="garch_spillover">GARCH-based (Detailed)</option>
                        </select>
                        <div class="parameter-help" id="method-help">
                            <strong>Choose based on your needs:</strong><br>
                            ‚Ä¢ <strong>Diebold-Yilmaz:</strong> Quick price spillovers<br>
                            ‚Ä¢ <strong>GARCH-based:</strong> Detailed volatility contagion (slower)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="d-grid gap-2 mt-4">
        <button type="submit" class="btn btn-primary btn-lg" id="run-analysis-btn">
            üöÄ Run Analysis
        </button>
    </div>
</form>

<div id="loading" class="text-center" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-2">Running analysis, please wait...</p>
</div>
{% endblock %}

{% block extra_js %}
<script>
// Event handlers for form submission
document.addEventListener('DOMContentLoaded', function() {
    // Symbol selection method toggle
    const manualRadio = document.getElementById('symbol-method-manual');
    const predefinedRadio = document.getElementById('symbol-method-predefined');
    const manualSection = document.getElementById('manual-symbol-entry');
    const predefinedSection = document.getElementById('predefined-symbol-selection');
    
    function updateSymbolSelectionDisplay() {
        if (manualRadio.checked) {
            manualSection.style.display = 'block';
            predefinedSection.style.display = 'none';
        } else {
            manualSection.style.display = 'none';
            predefinedSection.style.display = 'block';
        }
    }
    
    manualRadio.addEventListener('change', updateSymbolSelectionDisplay);
    predefinedRadio.addEventListener('change', updateSymbolSelectionDisplay);
    
    // Set initial state
    updateSymbolSelectionDisplay();

    // Toggle between market and synthetic data parameters
    const syntheticRadio = document.getElementById('data-source-synthetic');
    const yfinanceRadio = document.getElementById('data-source-actual-yfinance');
    const stooqRadio = document.getElementById('data-source-actual-stooq');
    const marketParams = document.getElementById('market-params');
    const syntheticParams = document.getElementById('synthetic-params');
    
    // Initialize display based on which radio is checked
    function updateDisplays() {
        if (syntheticRadio.checked) {
            marketParams.style.display = 'none';
            syntheticParams.style.display = 'block';
        } else {
            // For both actual data sources (Yahoo Finance and Stooq)
            marketParams.style.display = 'block';
            syntheticParams.style.display = 'none';
        }
    }
    
    // Set initial state
    updateDisplays();
    
    // Add event listeners for radio buttons
    syntheticRadio.addEventListener('change', updateDisplays);
    yfinanceRadio.addEventListener('change', updateDisplays);
       stooqRadio.addEventListener('change', updateDisplays);

    // Industry selection functionality
    const industryCheckboxes = document.querySelectorAll('.industry-checkbox');
    const selectedDisplay = document.getElementById('selected-symbols-display');
    const clearButton = document.getElementById('clear-industry-selections');
    const switchToManualButton = document.getElementById('switch-to-manual');
    
    let selectedSymbols = new Set();
    
    // Update selected symbols display
    function updateSelectedDisplay() {
        if (selectedSymbols.size === 0) {
            selectedDisplay.innerHTML = '<small class="text-muted">No symbols selected from industry groups</small>';
        } else {
            const symbolsArray = Array.from(selectedSymbols);
            selectedDisplay.innerHTML = symbolsArray.map(symbol => 
                `<span class="badge bg-primary me-1">${symbol}</span>`
            ).join('');
        }
    }
    
    // Handle checkbox changes
    industryCheckboxes.forEach(checkbox => {
        checkbox.addEventListener('change', function() {
            if (this.checked) {
                selectedSymbols.add(this.value);
            } else {
                selectedSymbols.delete(this.value);
            }
            updateSelectedDisplay();
        });
    });
    
    // Clear all selections
    clearButton.addEventListener('click', function() {
        industryCheckboxes.forEach(checkbox => {
            checkbox.checked = false;
        });
        selectedSymbols.clear();
        updateSelectedDisplay();
    });
    
    // Switch to manual entry with selected symbols
    switchToManualButton.addEventListener('click', function() {
        if (selectedSymbols.size === 0) {
            alert('No symbols selected to use.');
            return;
        }
        
        const symbolsArray = Array.from(selectedSymbols);
        const symbolsString = symbolsArray.join(',');
        
        // Switch to manual mode
        manualRadio.checked = true;
        updateSymbolSelectionDisplay();
        
        // Also trigger the data source display updates
        updateDisplays();
        
        // Populate the appropriate field based on data source selection
        if (syntheticRadio.checked) {
            const syntheticSymbolsField = document.getElementById('synthetic-symbols');
            syntheticSymbolsField.value = symbolsString;
        } else {
            const symbolsField = document.getElementById('symbols');
            symbolsField.value = symbolsString;
        }
        
        // Clear the industry selections after switching
        clearButton.click();
        
        // Show success message
        const originalText = switchToManualButton.textContent;
        switchToManualButton.textContent = 'Switched!';
        switchToManualButton.classList.remove('btn-outline-primary');
        switchToManualButton.classList.add('btn-success');
        
        setTimeout(() => {
            switchToManualButton.textContent = originalText;
            switchToManualButton.classList.remove('btn-success');
            switchToManualButton.classList.add('btn-outline-primary');
        }, 1500);
    });
    
    // Handle form submission
    const form = document.getElementById('analysis-form');
    const loadingIndicator = document.getElementById('loading');
    
    form.addEventListener('submit', function(e) {
        e.preventDefault();
        
        // Show loading indicator
        loadingIndicator.style.display = 'block';
        form.style.display = 'none';
        
        // Prepare form data
        const formData = new FormData(form);
        const data = {};
        
        // Convert FormData to a plain object
        for (const [key, value] of formData.entries()) {
            data[key] = value;
        }
        
        // Helper function to safely split and trim comma-separated values
        function parseCommaSeparated(value, defaultArray = []) {
            if (!value || value.trim() === '') {
                return defaultArray;
            }
            return value.split(',').map(s => s.trim()).filter(s => s.length > 0);
        }
        
        // Helper function to safely parse comma-separated numbers
        function parseCommaSeparatedNumbers(value, defaultArray = []) {
            if (!value || value.trim() === '') {
                return defaultArray;
            }
            return value.split(',').map(s => parseFloat(s.trim())).filter(n => !isNaN(n));
        }
        
        // Special handling for symbols with defaults
        if (data.symbols) {
            data.symbols = parseCommaSeparated(data.symbols, ['^DJI', '^HSI']);
        }
        
        if (data.synthetic_symbols) {
            data.synthetic_symbols = parseCommaSeparated(data.synthetic_symbols, ['GME', 'BYND', 'BP']);
        }
        
        // Handle synthetic anchor prices with defaults
        if (data.synthetic_anchor_prices) {
            data.synthetic_anchor_prices = parseCommaSeparatedNumbers(data.synthetic_anchor_prices, [150.0, 200.0, 15.0]);
        }
        
        // If synthetic data is selected, update the symbols array
        if (data.source_actual_or_synthetic_data === 'synthetic') {
            // Use the synthetic symbols instead of the regular symbols
            data.symbols = data.synthetic_symbols || ['GME', 'BYND', 'BP'];
            
            // Ensure anchor prices array matches symbols length
            if (!data.synthetic_anchor_prices || data.synthetic_anchor_prices.length !== data.symbols.length) {
                data.synthetic_anchor_prices = [150.0, 200.0, 15.0].slice(0, data.symbols.length);
            }
            
            // Clean up unused fields
            delete data.synthetic_symbols;
        } else {
            // For actual data, ensure we have default symbols if none provided
            if (!data.symbols || data.symbols.length === 0) {
                data.symbols = ['^DJI', '^HSI'];
            }
        }
        
        // Construct ARIMA and GARCH params objects with defaults
        data.arima_params = {
            p: parseInt(data.arima_p) || 2,
            d: parseInt(data.arima_d) || 1,
            q: parseInt(data.arima_q) || 4
        };
        
        data.garch_params = {
            p: parseInt(data.garch_p) || 1,
            q: parseInt(data.garch_q) || 1,
            dist: data.garch_dist || 't'
        };
        
        // Handle spillover options with defaults
        data.spillover_enabled = document.getElementById('enable-spillover').checked;
        
        // --- SPILLOVER METHOD LOGIC ---
        // The backend will use returns for Diebold-Yilmaz (DY) spillover, but GARCH-based spillover requires
        // the GARCH conditional volatility series. This distinction is required for correct results.
        // Using the wrong input will give meaningless spillover metrics.
        if (data.spillover_enabled) {
            const spilloverMethod = document.getElementById('spillover-method').value;
            data.spillover_params = {
                forecast_horizon: parseInt(data.forecast_horizon) || 5,
                method: spilloverMethod
            };
        }
        
        // Remove individual parameters that are now in objects
        delete data.arima_p;
        delete data.arima_d;
        delete data.arima_q;
        delete data.garch_p;
        delete data.garch_q;
        delete data.garch_dist;
        delete data.forecast_horizon;
        
        console.log("Sending data to API:", data);
        
        // Send the AJAX request
        fetch('/api/run_pipeline/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': data.csrfmiddlewaretoken
            },
            body: JSON.stringify(data)
        })
        .then(response => {
            if (!response.ok) {
                return response.json().then(err => {
                    throw new Error(`API Error: ${JSON.stringify(err)}`);
                });
            }
            return response.json();
        })
        .then(responseData => {
            // Log the response data
            console.log("API Response received:", responseData);
            
            // Transform spillover data for better frontend display
            if (responseData.spillover_results) {
                console.log("=== SPILLOVER DATA TRANSFORMATION ===");
                
                // Transform pairwise spillover data for table display
                if (responseData.spillover_results.pairwise_spillover) {
                    const pairwiseData = [];
                    Object.entries(responseData.spillover_results.pairwise_spillover).forEach(([pair, data]) => {
                        const [from, to] = pair.split('_to_');
                        pairwiseData.push({
                            from: from,
                            to: to,
                            relationship: pair,
                            r_squared: data.r_squared,
                            r_squared_percent: (data.r_squared * 100).toFixed(2),
                            significant_lags: data.significant_lags,
                            significant_lags_text: data.significant_lags.length > 0 ? data.significant_lags.join(', ') : 'None',
                            strength: data.r_squared > 0.25 ? 'Strong' : data.r_squared > 0.10 ? 'Moderate' : 'Weak'
                        });
                    });
                    
                    // Sort by R¬≤ value (strongest first)
                    pairwiseData.sort((a, b) => b.r_squared - a.r_squared);
                    
                    // Add transformed data to spillover results
                    responseData.spillover_results.pairwise_spillover_table = pairwiseData;
                    
                    console.log("Transformed pairwise spillover data:", pairwiseData);
                }
                
                console.log("=== END SPILLOVER DATA TRANSFORMATION ===");
            }
            
            try {
                // Process original_data to ensure it has the correct structure
                if (responseData.original_data && !Array.isArray(responseData.original_data)) {
                    // Convert from nested object to array of objects if needed
                    const tempArray = [];
                    const dateField = 'Date';
                    
                    for (const dateStr in responseData.original_data) {
                        if (responseData.original_data.hasOwnProperty(dateStr)) {
                            const dataPoint = responseData.original_data[dateStr];
                            dataPoint[dateField] = dateStr;
                            tempArray.push(dataPoint);
                        }
                    }
                    
                    // Sort by date
                    tempArray.sort((a, b) => new Date(a[dateField]) - new Date(b[dateField]));
                    responseData.original_data = tempArray;
                }
                
                // Similarly, check and process other data arrays if needed
                ['returns_data', 'scaled_data', 'pre_garch_data', 'post_garch_data'].forEach(field => {
                    if (responseData[field] && !Array.isArray(responseData[field])) {
                        const tempArray = [];
                        const dateField = 'Date';
                        
                        for (const dateStr in responseData[field]) {
                            if (responseData[field].hasOwnProperty(dateStr)) {
                                const dataPoint = responseData[field][dateStr];
                                dataPoint[dateField] = dateStr;
                                tempArray.push(dataPoint);
                            }
                        }
                        
                        // Sort by date
                        tempArray.sort((a, b) => new Date(a[dateField]) - new Date(b[dateField]));
                        responseData[field] = tempArray;
                    }
                });
                
                // Attempt to save to sessionStorage
                sessionStorage.setItem('analysisResults', JSON.stringify(responseData));
                console.log("Successfully saved to sessionStorage");
            } catch (error) {
                console.error("Error processing data or saving to sessionStorage:", error);
            }
            
            // Redirect to results page
            window.location.href = '/results/';
        })
        .catch(error => {
            console.error('Error:', error);
            // Show proper error message
            loadingIndicator.style.display = 'none';
            form.style.display = 'block';
            alert(`Error running analysis: ${error.message}`);
        });
    });

    // Toggle Spillover parameters
    const spilloverSwitch = document.getElementById('enable-spillover');
    const spilloverParams = document.getElementById('spillover-params');

    spilloverSwitch.addEventListener('change', function() {
        spilloverParams.style.display = this.checked ? 'block' : 'none';
    });
    
    // Help toggle functionality
    const helpToggles = document.querySelectorAll('.help-toggle');
    
    helpToggles.forEach(toggle => {
        toggle.addEventListener('click', function(e) {
            e.preventDefault();
            const targetId = this.getAttribute('data-target');
            const helpSection = document.getElementById(targetId);
            
            if (helpSection) {
                if (helpSection.classList.contains('show')) {
                    helpSection.classList.remove('show');
                    this.classList.remove('expanded');
                    this.classList.add('collapsed');
                } else {
                    helpSection.classList.add('show');
                    this.classList.remove('collapsed');
                    this.classList.add('expanded');
                }
            }
        });
    });

    // Set initial spillover display state
    spilloverParams.style.display = spilloverSwitch.checked ? 'block' : 'none';
});
</script>
{% endblock %}
